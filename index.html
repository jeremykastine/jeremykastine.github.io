
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Can you canon?</title>    
</head>
<body> 
    <div id="title" style="margin: auto; width:500px;">
        <h1 style="text-align: center;">Can you canon?</h1>
        <h2 style="text-align: center;">A rhythmic canon game by Jeremy Kastine</h2>
        <label>Select a level: </label>
        <select id="selectedCanon" >
            <option value="level0">0</option>
            <option value="level1">1</option>
            <option value="level2">2</option>
            <option value="level3">3</option>
            <option value="level4">4</option>
            <option value="level5">5</option>
            <option value="level6">6</option>
        </select>
        <button onclick="playNote(new Synth(new Timbre('square',2000,10), null, new Envelope([1,1,0],[.01,.2,.3]), 1, 0),440)">Check volume</button>
        <button onclick="begin()">Start playing</button>
        
        <p>
        How to play: <br><br>
        The goal of the game is to get all of the characters across the screen. 
        The unlabeled circle-shaped ones move on their own, but the labeled hand-shaped ones need help getting past each cusp. 
        To help them along, use the finger indicated on the label to press the corresponding key:
        <ul>
            <li>Right thumb (R1) on H</li>
            <li>Right fingers (R2-R5) on 7,8,9,0</li>
            <li>Left thumb (L1) on F</li>
            <li>Left fingers (L2-L5) on 4,3,2,1</li>
        </ul> 
        Tip: If you set your browser window relatively small (narrow, in particular) the characters will move more slowly, and it will be easier to read the labels. You can also adjust the tempo.<br><br>
        As you become more successful, your score indicated by the progress bar in the background will go up, and so will the number of characters that you must simultaneously mangage. Get your progress bar to the top of the screen, and you win!</p>
    </div>
    <div id="controls" style="display:none;">
        <div> <button onclick="stopNow=true">Stop</button> </div>
        <div style="position: absolute; top: 0; right: 0;">
            <label for="tempoSlider">Tempo
            <input type="range" min="100" max="200" value="150" step="5" class="slider" id="tempoSlider" oninput="this.nextElementSibling.value = this.value; bpm = this.value;">
            <output id="tempoSliderValue"></output>
            </label>
        </div>
        <canvas id="myCanvas" style="margin-top:5px; border:1px solid #000000;"> </canvas>
    </div>
    


    

    
    
    
    <script>
        var character,part,rhythm,composite;
        var prevTime,prevBeat,curBeat,curTime;
        var lineHeight,lineFade;
        var zeroPitch,bpm;
        var chanceUser;
        var windowLeft,windowRight,windowBottom,windowTop;
        var stopNow;
        function loadCanon(){
            composite = {rhythm:[], period:0, melody:[], synth:new Synth(new Timbre("sine",220,0.001), null, new Envelope([1,1,0],[.01,.05,.06]), .1, 0)};
            zeroPitch = 220; bpm = 150;
            switch(document.getElementById("selectedCanon").value){
                case "level0": 
                    rhythm = [0,1,2,3];
                    part=[
                        new Part(1,0,16,[0,4,7,4],4,[-2,2,5,2],4),
                        new Part(1,4,16,[0,4,7,4],4,[-2,2,5,2],4),
                        new Part(1,8,16,[5,9,12,9],4,[-2,2,5,2],4),
                        new Part(1,12,16,[7,11,14,11],4,[-2,2,5,2],4),
                    ];
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                    composite.period=16; 
                    composite.melody=[0,4,7,4,0,4,7,4,5,9,12,9,7,11,14,11];
                    windowLeft = -4; windowRight = 6; windowBottom = -6; windowTop = 18;
                    break;
                case "level1": 
                    rhythm = [0,2,4];
                    part=[
                        new Part(1,0,12,[7,4,0],4,[5,2,-2],4),
                        new Part(1,3,12,[10,7,3],4,[5,2,-2],4),
                        new Part(1,6,12,[13,10,6],4,[5,2,-2],4),
                        new Part(1,9,12,[16,13,9],4,[5,2,-2],4),
                    ];
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11];
                    composite.period=12; 
                    composite.melody=[7,9,4,10,0,7,13,3,10,16,6,13];
                    windowLeft = -4; windowRight = 8; windowBottom = -6; windowTop = 20;
                    break;
                case "level2": 
                    rhythm = [0,5,6,11];
                    part=[
                        new Part(1,5,19,[1,5,0,4],4,[-5,-1,-6,-2],4),
                        new Part(1,8,19,[5,9,4,8],4,[-5,-1,-6,-2],4),
                        new Part(1,15,19,[-3,1,-4,0],4,[-5,-1,-6,-2],4),
                        new Part(1,17,19,[9,13,8,12],4,[-5,-1,-6,-2],4),
                    ];
                    composite.rhythm=[0,1,2,3,4,5,7,8,9,10,11,13,14,15,16,17];
                    composite.period=19; 
                    composite.melody=[8,1,-4,13,8,1,0,5,12,5,0,9,4,-3,4,9];
                    windowLeft = -6; windowRight = 14; windowBottom = -8; windowTop = 16;
                    break;
                case "level3": 
                    rhythm = [0,2,7,8,11];
                    part=[
                        new Part(1,0,25,[0,7,8,2,11],4,[0,7,8,2,11],4),
                        new Part(1,2,25,[7,14,15,9,18],4,[0,7,8,2,11],4),
                        new Part(1,7,25,[8,15,16,10,19],4,[0,7,8,2,11],4),
                        new Part(1,8,25,[2,9,10,4,13],4,[0,7,8,2,11],4),
                        new Part(1,11,25,[11,18,19,13,22],4,[0,7,8,2,11],4),
                    ];
                    composite.rhythm=[0,2,4,7,8,9,10,11,13,14,15,16,18,19,22];
                    composite.period=25; 
                    composite.melody=[0,7,14,8,2,15,9,11,18,16,10,4,19,13,22];
                    windowLeft = -6; windowRight = 14; windowBottom = -4; windowTop = 26;
                    break;
                case "level4":
                    rhythm  = [0,2,7,8,11];
                    part=[
                        new Part(1,0,25,[0,7,8,2,11],4,[0,7,8,2,11],4),
                        new Part(1,3,25,[9,16,17,11,20],4,[0,7,8,2,11],4),
                        new Part(1,4,25,[3,10,11,5,14],4,[0,7,8,2,11],4),
                        new Part(1,9,25,[4,11,12,6,15],4,[0,7,8,2,11],4),
                        new Part(1,11,25,[11,18,19,13,22],4,[0,7,8,2,11],4),
                    ];
                    composite.rhythm=[0,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,22];
                    composite.period=25; 
                    composite.melody=[0,7,9,3,16,10,8,2,4,17,11,5,18,20,14,12,6,19,13,15,22];
                    windowLeft = -6; windowRight = 14; windowBottom = -4; windowTop = 26;
                    break;
                case "level5":
                    rhythm = [0, 1.7, 3.37, 7.1];
                    part=[
                        new Part(1,0,16.3,[10,1.6,7.2,4.4],4,[4.8,0,3.2,1.6],4),
                        new Part(1.4,3.37,16.3,[7.2,1.2,5.2,3.2],4,[4.8,0,3.2,1.6],4),
                        new Part(.8,4.39,16.3,[6,1.2,4.4,2.8],4,[4.8,0,3.2,1.6],4),
                        new Part(1.25,9.1,16.3,[4.8,0,3.2,1.6],4,[4.8,0,3.2,1.6],4),
                        new Part(1.18,12.33,16.3,[14,2,10,6],4,[4.8,0,3.2,1.6],4),
                    ];
                    composite.rhythm=[0,1.6875,3.37,4.399,5.75,7.1,8.1,9.1,10.1,11.225,12.33,13.33,14.33];
                    composite.period=16.3; 
                    composite.melody=[10,1.6,7.2,6,1.2,4.4,5.2,4.8,2.8,0,14,3.2,2];
                    windowLeft = -6; windowRight = 11; windowBottom = -4; windowTop = 18;
                    break;
                case "level6":
                    rhythm = [0,3,5];
                    part=[
                        new Part(1,0,12,[6,7,0],4,[-1,0,-7],4),
                        new Part(-1,7,12,[9,10,3],4,[-1,0,-7],4),
                        new Part(1,6,12,[5,4,11],-4,[12,11,18],-4),
                        new Part(-1,1,12,[2,1,8],-4,[12,11,18],-4),
                    ];
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11];
                    composite.period=12; 
                    composite.melody=[6,2,3,7,10,0,5,9,8,4,1,11];
                    windowLeft = -6; windowRight = 11; windowBottom = -9; windowTop = 20;
                    break;
            }
            chanceUser = 1/part.length;
            document.getElementById("tempoSlider").value = bpm;
            document.getElementById("tempoSliderValue").value=bpm;
        }
        

        
        



        function begin(){

            stopNow=false;
            loadCanon();
            document.getElementById("title").style.display="none";
            document.getElementById("controls").style.display="block";
            
            
            prevTime = new Date().getTime();
            prevBeat = -.9;
            curBeat = -.9;
            curTime = new Date().getTime();
            character = []
            UpdateScreen();

        }

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playNote(synth,freq){
            var mainOsc = audioCtx.createOscillator();
            var mainFilter = audioCtx.createBiquadFilter();
            var mainGainA= audioCtx.createGain();
            var mainGainB = audioCtx.createGain();
            var mainPan = audioCtx.createStereoPanner();
            mainOsc.connect(mainFilter);
            mainFilter.connect(mainGainA);
            mainGainA.connect(mainGainB);
            mainGainB.connect(mainPan);
            mainPan.connect(audioCtx.destination);

            mainOsc.type = synth.timbre.osc;
            
            mainOsc.frequency.value = freq;
            mainFilter.type = "bandpass";
            mainFilter.Q.value=synth.timbre.filterQ;
            mainFilter.frequency.value=synth.timbre.filterFreq;
            mainGainB.gain.value=0;
            mainPan.pan.value=synth.pan;
            let now=audioCtx.currentTime;

            mainGainB.gain.setValueAtTime(0,now);
            for(let i=0;i<synth.envelope.gain.length;i++){
                mainGainB.gain.linearRampToValueAtTime(synth.envelope.gain[i],now+synth.envelope.time[i]);
            }
            mainOsc.start(now);
            let endNote = now+synth.envelope.time[synth.envelope.time.length-1]+.1;
            mainOsc.stop(endNote);
            
             
            mainGainA.gain.value=synth.gain;
            if(synth.lfo != null){
                var lfoOsc = audioCtx.createOscillator();
                var lfoGain = audioCtx.createGain();
                lfoOsc.connect(lfoGain);
                if(synth.lfo.type=="vib"){
                    lfoGain.connect(mainOsc.detune);
                    lfoGain.gain.value=synth.lfo.amp;
                } else {
                    lfoGain.connect(mainGainA.gain);
                    mainGainA.gain.value=synth.gain*(1-synth.lfo.amp/2);
                    lfoGain.gain.value=synth.gain*synth.lfo.amp/2;
                }
                
                lfoOsc.type=synth.lfo.osc;
                lfoOsc.frequency.value=synth.lfo.freq;
                lfoOsc.start(now);
                lfoOsc.stop(endNote);
            }       
        }




        
        var canvas = document.getElementById("myCanvas");
        var c = canvas.getContext("2d");

        function Character(part,iteration,status,nextNote,xPos,yPos,user,synth,deadFade,hand,finger){
            this.part=part;
            this.iteration=iteration;
            this.status=status; 
            this.nextNote=nextNote;
            this.xPos=xPos;
            this.yPos=yPos;
            this.user=user;
            this.synth=synth;
            this.deadFade=deadFade;
            this.hand=hand;
            this.finger=finger;
            this.prevNote = function () {
                if (this.part.aug>0){
                    return this.nextNote-1;
                } else {
                    return this.nextNote+1;
                }
            }
            this.PositionY = function(melodyOrBase) {
                if (melodyOrBase=="melody"){
                    melodyOrBase=this.part.melody;
                    dip=this.part.mDip;
                } else {
                    melodyOrBase=this.part.base;
                    dip=this.part.bDip;
                }
                if((this.part.aug>0 && this.nextNote==0) || (this.part.aug<0 && this.nextNote==-1)){
                    x1=windowLeft;
                    if(dip>0){y1=windowBottom+melodyOrBase[0]-this.part.base[0]}else{y1=windowTop+melodyOrBase[0]-this.part.base[0]}
                    x2=rhythm[0]-1;
                    y2=y1;
                    x3=rhythm[0];
                    y3=melodyOrBase[0];
                }else if((this.part.aug>0 && this.nextNote==rhythm.length) || (this.part.aug<0 && this.nextNote==rhythm.length-1)){
                    x1=rhythm[rhythm.length-1];
                    y1=melodyOrBase[rhythm.length-1];
                    x2=rhythm[rhythm.length-1]+1;
                    if(dip>0){y2=windowBottom+melodyOrBase[0]-this.part.base[0]}else{y2=windowTop+melodyOrBase[0]-this.part.base[0]}
                    x3=windowRight;
                    y3=y2;
                }else {
                    x1=rhythm[this.prevNote()];
                    y1=melodyOrBase[this.prevNote()];
                    x3=rhythm[this.nextNote];
                    y3=melodyOrBase[this.nextNote];
                    x2=(x1+x3)/2;
                    if(this.part.mDip>0){
                        y2=Math.min(y1,y3)-dip;
                    } else {
                        y2=Math.max(y1,y3)-dip;
                    }
                }
                
                return quadraticFunction(x1,y1,x2,y2,x3,y3,this.xPos);

            }
            this.update = function () {
                

                xOld = PositionX(this.part,prevBeat,this.iteration);
                xNew = PositionX(this.part,curBeat,this.iteration);
                
                if(this.status=="dead"){
                    this.deadFade=this.deadFade*.9;
                } else if(this.user){
                    if(xNew>windowRight+.5 || xNew<windowLeft-.5){
                        this.status="done";

                    } else if(inInterval(rhythm[this.nextNote]-.4/this.part.aug,xOld,xNew)){
                        if(this.status=="traveling"){this.status="prebeat1";}
                    } else if(inInterval(rhythm[this.nextNote],xOld,xNew)){
                        if(this.status=="prebeat1"){
                            this.status="postbeat";
                        } else if(this.status=="prebeat2"){
                            this.status="traveling";
                            this.nextNote=this.nextNote+Math.sign(this.part.aug);
                        }
                    } else if(inInterval(rhythm[this.nextNote]+.4/this.part.aug,xOld,xNew)){
                        if(this.status!=="traveling"){
                            this.status="dead";
                            changeChance(-1);
                        }
                    }
                    if(this.status=="traveling" || this.status=="prebeat1"){
                        this.xPos = xNew;
                        this.yPos = this.PositionY("melody");
                    } else {
                        this.xPos = rhythm[this.nextNote];
                        this.yPos = this.part.melody[this.nextNote];
                    } 
                }else{
                    if(xNew>windowRight+.5 || xNew<windowLeft-.5){
                        this.status="done";
                    } else if(inInterval(rhythm[this.nextNote],xOld,xNew)){
                        playNote(this.synth,zeroPitch*Math.pow(2,this.part.melody[this.nextNote]/12));
                        this.xPos = rhythm[this.nextNote];
                        this.yPos = this.part.melody[this.nextNote];
                        this.nextNote=this.nextNote+Math.sign(this.part.aug);
                    } else {
                        this.xPos = xNew;
                        this.yPos = this.PositionY("melody");
                    }
                }
            };
            
        }
        function changeChance(d){
            if(d>0){
                chanceUser=chanceUser+1/(rhythm.length*part.length);
            } else {
                chanceUser=chanceUser-1/part.length;
                if(chanceUser<1/part.length){
                    chanceUser=1/part.length;
                } else if(chanceUser>1) {
                    chanceUser=1;
                }
            }
        }
        function quadraticFunction(x1,y1,x2,y2,x3,y3,x){

            let a=x1-2*x2+x3;
            let b=-2*x1+2*x2;
            let c=x1-x;
            var t;
            if(Math.abs(a)<.0001){
                t=-c/b;
            } else{
                t=(-b+Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);
            }
            return Math.pow(1-t,2)*y1+2*(1-t)*t*y2+Math.pow(t,2)*y3;
        }

        function PositionX(p,b,i){
            return (b-p.trans-i*p.period)/p.aug;
        }


        
        document.addEventListener('keydown', logKey);

        function logKey(e) {
            var ehand, efinger;
            switch(e.key){
                case "h": ehand="R"; efinger="1"; break;
                case "H": ehand="R"; efinger="1"; break;
                case "7": ehand="R"; efinger="2"; break;
                case "8": ehand="R"; efinger="3"; break;
                case "9": ehand="R"; efinger="4"; break;
                case "0": ehand="R"; efinger="5"; break;
                case "f": ehand="L"; efinger="1"; break;
                case "F": ehand="L"; efinger="1"; break;
                case "4": ehand="L"; efinger="2"; break;
                case "3": ehand="L"; efinger="3"; break;
                case "2": ehand="L"; efinger="4"; break;
                case "1": ehand="L"; efinger="5"; break;
                default: ehand=null; efinger=null;
            }
            for(let i=0;i<character.length;i++){
                if(character[i].hand==ehand && character[i].finger==efinger){
                    if(character[i].status=="prebeat1"){
                        changeChance(1);
                        playNote(character[i].synth,zeroPitch*Math.pow(2,character[i].part.melody[character[i].nextNote]/12));
                        character[i].status="prebeat2";
                    } else if(character[i].status=="postbeat"){
                        changeChance(1);
                        playNote(character[i].synth,zeroPitch*Math.pow(2,character[i].part.melody[character[i].nextNote]/12));
                        character[i].status="traveling";
                        character[i].nextNote=character[i].nextNote+Math.sign(character[i].part.aug);
                    } else if(character[i].status=="traveling" && character[i].xPos>Math.min(...rhythm)-1.5 && character[i].xPos<Math.max(...rhythm)){
                        character[i].status="dead";
                        changeChance(-1);
                    }
                    return;
                }
            }

        }
        

        function inInterval(a,b,c){
            if(a>=Math.min(b,c) && a<Math.max(b,c)){
                return true;
            } else {
                return false;
            }
        }

        function scaleX(x){
            return (x-windowLeft)/(windowRight-windowLeft)*canvas.width;
        }
        function scaleY(y){
            return (windowTop-y)/(windowTop-windowBottom)*canvas.height;
        }

        function drawEverything(){
            c.beginPath();
            let p=(chanceUser-1/part.length)/(2-1/part.length);
            c.rect(0,canvas.height*(1-p),canvas.width,canvas.height*p);
            c.fillStyle="WhiteSmoke";
            c.fill();
            c.fillStyle="Black";
            c.beginPath();
            c.moveTo(0,scaleY(lineHeight));
            c.lineTo(canvas.width,scaleY(lineHeight));
            lineFade=lineFade*.9;
            c.globalAlpha=lineFade;
            c.stroke();
            c.globalAlpha=1;
            var cx;
            var cy;
            var nx;
            var ny;
            var x0, y0;
            var charColor;
            for(let i=0;i<part.length;i++){
                
                c.beginPath();
                nx=windowLeft;
                if(part[i].bDip>0){ny=windowBottom;} else {ny=windowTop;}
                c.moveTo(scaleX(nx), scaleY(ny));
                cx=rhythm[0]-1;
                cy=ny;
                nx=rhythm[0];
                ny=part[i].base[0];
                c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                for(let j=1;j<rhythm.length;j++){
                    cx=(rhythm[j-1]+rhythm[j])/2;
                    if(part[i].bDip>0){
                        cy=Math.min(part[i].base[j-1],part[i].base[j])-part[i].bDip;
                    } else{
                        cy=Math.max(part[i].base[j-1],part[i].base[j])-part[i].bDip;
                    }
                    nx=rhythm[j];
                    ny=part[i].base[j];
                    c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                }
                cx=rhythm[rhythm.length-1]+1;
                if(part[i].bDip>0){cy=windowBottom;} else {cy=windowTop;}
                nx=windowRight;
                ny=cy;
                c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                c.stroke(); 
            }
            var r;
            for(let i=0;i<character.length;i++){
                x0=scaleX(character[i].xPos);
                y0=scaleY(character[i].yPos);
                if (character[i].status=="dead"){
                    c.globalAlpha=character[i].deadFade;
                    c.beginPath();
                    c.moveTo(x0 , y0);
                    c.lineTo(x0 , scaleY(character[i].PositionY("base")));
                    c.stroke();
                    c.beginPath();
                    c.moveTo(x0-10, y0-10);
                    c.lineTo(x0+10, y0+10);
                    c.stroke();
                    c.beginPath();
                    c.moveTo(x0+10, y0-10);
                    c.lineTo(x0-10, y0+10);
                    c.stroke();
                    c.globalAlpha=1;
                } else {
                    c.beginPath();
                    c.moveTo(x0 , y0);
                    c.lineTo(x0 , scaleY(character[i].PositionY("base")));
                    c.stroke();
                    c.beginPath();
                    c.arc(x0,y0,14,0,6.3);
                    c.fillStyle = "White";
                    c.fill();
                    c.stroke();
                    if(character[i].user){
                        if(character[i].hand=="L"){
                            r=1;
                        } else {
                            r=-1;
                        }
                        c.beginPath();
                        c.moveTo(x0-14*r,y0-9);
                        c.lineTo(x0-19*r,y0-29);
                        c.lineTo(x0-15*r,y0-30);
                        c.lineTo(x0-9*r,y0-14);
                        c.lineTo(x0-14*r,y0-9);
                        if(character[i].finger==5){c.fillStyle = "Black";} else {c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0-1*r,y0-17);
                        c.lineTo(x0-2*r,y0-41);
                        c.lineTo(x0-7*r,y0-41);
                        c.lineTo(x0-7*r,y0-15);
                        c.lineTo(x0-1*r,y0-17);
                        if(character[i].finger==4){c.fillStyle = "Black";} else {c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0+6*r,y0-15);
                        c.lineTo(x0+7*r,y0-43);
                        c.lineTo(x0+1*r,y0-44);
                        c.lineTo(x0+0*r,y0-17);
                        c.lineTo(x0+6*r,y0-15);
                        if(character[i].finger==3){c.fillStyle = "Black";} else {c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0+13*r,y0-11);
                        c.lineTo(x0+17*r,y0-37);
                        c.lineTo(x0+12*r,y0-38);
                        c.lineTo(x0+7*r,y0-15);
                        c.lineTo(x0+13*r,y0-11);
                        if(character[i].finger==2){c.fillStyle = "Black";} else {c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0+14*r,y0+10);
                        c.lineTo(x0+30*r,y0-9);
                        c.lineTo(x0+27*r,y0-13);
                        c.lineTo(x0+17*r,y0-3);
                        c.lineTo(x0+14*r,y0+10);
                        if(character[i].finger==1){c.fillStyle = "Black";} else {c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.font = "14px Arial";
                        c.textAlign = "center";
                        c.textBaseline = "middle";
                        c.fillStyle = "Black";
                        c.fillText(character[i].hand+character[i].finger, scaleX(character[i].xPos) , scaleY(character[i].yPos)); 
                    }
                }
                
            }
            
        }

        function SpawnNewCharacter(p){
            
            var spawnPoint;
            var nextNote;
            if(p.aug>0){
                spawnPoint = windowLeft;
                nextNote = 0;
            } else {
                spawnPoint = windowRight;
                nextNote = rhythm.length-1;
            }
            let i = Math.round((spawnPoint*p.aug-curBeat+p.trans)/-p.period);
            if(inInterval(spawnPoint,PositionX(p,curBeat,i),PositionX(p,prevBeat,i))){
                var user, curUser=0;
                if(character.length==0){
                    user = Math.random()<=chanceUser;
                } else {
                    for(let j=0;j<character.length;j++){
                        if (character[j].user==true){curUser++}
                    }
                    user = Math.random()<=chanceUser - .5*(curUser/character.length-chanceUser);
                }
                if(user || Math.random()<.5){
                    var hand, finger;
                    if(user==false){
                        hand=null;
                        finger=null;
                    } else {
                        var r = [0,0,0,0,0,0,0,0,0,0];
                        var rc = 0;
                        for(let i=0;i<character.length;i++){
                            if(character[i].hand != null){
                                if(character[i].hand=="L"){
                                    r[5+character[i].finger-1]=1;
                                } else {
                                    r[character[i].finger-1]=1;
                                }
                                rc++;
                            }
                        } 
                        
                        if(rc==10){
                            user=false;
                        } else {
                            let chc=Math.random()*(9.99-rc);
                            rc=0
                            for(let i=0;i<10;i++){
                                if(r[i]==0){rc++}
                                if(rc>=chc){
                                    if(i<5) {hand="R"} else {hand="L"}
                                    finger=(i % 5)+1;
                                    break;
                                }
                            }
                        }

                    }
                    let osc=Math.random();
                    if(osc<.5){
                        osc="square";
                    } else {
                        osc="sawtooth";
                    }
                    let midrange=(Math.max(...p.melody)+Math.min(...p.melody))/2;
                    let filterFreq=zeroPitch*Math.pow(2,midrange/12+4*Math.random());
                    let filterQ=10;
                    let envChoice=Math.floor(Math.random()*7.99);
                    var envGain;
                    var envTime;
                    switch(envChoice) {
                    case 0: envGain=[1,1,0]; envTime=[.01,.2,.3]; break; // regular attack, short sustain, regular release
                    case 1: envGain=[1,1,0]; envTime=[.01,.2,.7]; break; // regular attack, short sustain, decay
                    case 2: envGain=[3,1,1,0]; envTime=[.01,.05,.2,.3]; break; // hard attack, short sustain, regular release
                    case 3: envGain=[3,1,1,0]; envTime=[.01,.05,.2,.7]; break; // hard attack, short sustain, decay
                    case 4: envGain=[1,1,0]; envTime=[.1,.2,.3]; break; // soft attack, short sustain, regular release
                    case 5: envGain=[1,1,0]; envTime=[.1,.2,.7]; break; // soft attack, short sustain, decay
                    case 6: envGain=[3,2,0]; envTime=[.01,.14,.15]; break; 
                    case 7: envGain=[3,0]; envTime=[.14,.15]; break;
                    default: envGain=[1,1,0]; envTime=[.01,.2,.3]; break; 
                    } 
                    var lfoType,lfoOsc,lfoFreq,lfoAmp;
                    
                    if(Math.random()<.5){
                        if(Math.random()<.5){
                            lfoType="vib";
                            lfoFreq=6*Math.pow(2,Math.random());
                            lfoOsc="sine";
                            lfoAmp=5+Math.random()*20;
                            lfoShift=0;
                        }else{
                            lfoType="trem";
                            lfoFreq=20*Math.pow(2,Math.random());
                            if(Math.random()<.5){
                                lfoOsc="sine";
                                lfoAmp=.1+.9*Math.random();
                            } else {
                                lfoOsc="square";
                                lfoAmp=1;
                            }
                        }
                    } else {
                        lfoType="none";
                    }
                    
                    
                    if(user){
                        gain=.8;
                    } else {
                        gain=.2;
                    }
                    let pan=Math.random()*2-1;
                    if(lfoType=="none"){
                        character.push(new Character(p,i,"traveling",nextNote,0,0,user, new Synth(new Timbre(osc,filterFreq,filterQ), null, new Envelope(envGain,envTime), gain, pan),1,hand,finger));
                    } else {
                        character.push(new Character(p,i,"traveling",nextNote,0,0,user, new Synth(new Timbre(osc,filterFreq,filterQ), new Lfo(lfoType,lfoOsc,lfoFreq,lfoAmp), new Envelope(envGain,envTime), gain, pan),1,hand,finger));
                    }
                        
                }
            }
        }

        function UpdateScreen(){
            if(chanceUser>2){
                alert('YOU WIN!');
                stopNow=true;
            }
            prevTime=curTime;
            curTime=new Date().getTime();
            prevBeat = curBeat;
            curBeat = curBeat+bpm/60*.001*(curTime-prevTime);
            canvas.height=window.innerHeight-60;
            canvas.width=window.innerWidth-15;
            var e1;
            var e2;
            for(let i=0;i<composite.rhythm.length;i++){
                e1=((prevBeat+.5) % composite.period)-.5;
                e2=((curBeat+.5) % composite.period)-.5;
                if(e1<composite.rhythm[i] && composite.rhythm[i]<=e2){
                    playNote(composite.synth,zeroPitch*Math.pow(2, composite.melody[i]/12));
                    lineHeight=composite.melody[i];
                    lineFade=1;
                    break;
                }
            }
            for(let i=0;i<part.length;i++){
               SpawnNewCharacter(part[i]);
            }
            //if(document.hasFocus==false){character=[]}
            for(let i=0;i<character.length;i++){
               character[i].update();
               if (character[i].deadFade<.1 || character[i].status=="done"){
                   character.splice(i, 1);
                   i=i-1;
               }
            }
            drawEverything();
            if(document.hasFocus && !document.hidden && !stopNow){
                requestAnimationFrame(UpdateScreen);
            } else {
                character=[];
                c.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById("title").style.display="block";
                document.getElementById("controls").style.display="none";
            }
            
        }
        
        function Part(aug,trans,period,melody,mDip,base,bDip){
            this.aug = aug;
            this.trans = trans;
            this.period = period;
            this.melody = melody;
            this.mDip = mDip;
            this.base = base;
            this.bDip = bDip;
        }

        function Timbre(osc,filterFreq,filterQ){
            this.osc = osc;
            this.filterFreq = filterFreq;
            this.filterQ = filterQ;
        }
        function Lfo(type,osc,freq,amp){
            this.type = type;
            this.osc = osc;
            this.freq = freq;
            this.amp = amp;
        }
        function Envelope(gain,time){
            this.gain = gain;
            this.time = time;
        }
        function Synth(timbre,lfo,envelope,gain,pan){
            this.timbre = timbre;
            this.lfo = lfo;
            this.envelope = envelope;
            this.gain = gain;
            this.pan = pan;
        }

    </script>
</body>
</html>