



<!DOCTYPE html>
<html lang="en">





<head>
    <meta charset="UTF-8">
    <title>Can you canon?</title>
    <style type="text/css">
        canvas {
            position: fixed;
        }
        textarea {
            resize: none;
        }

      body,html {
        margin: 0;
        padding: 0;
    }

#container {
    position: relative;
    height: 100vh;
}
#controls {
    position: absolute;
    bottom: 0;
    left: 0;
}
#buttons {
    position: absolute;
    top: 0;
    left: 0;
}
    #currentScore{
        position: absolute;
        top: 0;
        right: 0;
        font-size:20px; 
        text-align: center;

    }
    </style>
    
</head>
<body> 
    <canvas id="myCanvas" style="z-index:-1"> </canvas>
    <div id="title" style="text-align: center;">
        <h1>Can you canon?</h1>
        <h2>A rhythmic canon game by Jeremy Kastine</h2>
        <label>Select a level: </label>
        <select id="selectedCanon" onchange="playNote(new Synth(new Timbre('square',2000,10), new Lfo('trem','square',1,1), new Envelope([1,0],[.01,.02]), 0, 0),220);">
            <option value="level1">1</option>
            <option value="level2">2</option>
            <option value="level3">3</option>
            <option value="level4">4</option>
            <option value="level5">5</option>
            <option value="Popham">Popham</option>
            <option value="Bennett">Bennett</option>
            <option value="Algarin">Algarin</option>
            <option value="Grizzle">Grizzle</option>
            <option value="Hancock">Hancock</option>
        </select>
        
        <button onclick="begin()">Start</button>
    </div>
    <div id="container"  style="display:none;">
        <div id="currentScore" ></div>
        <div id="buttons">
            <button onclick="alert('The goal is to get all of the characters across the screen. The unlabeled circle-shaped ones move on their own, but the labeled hand-shaped ones need help getting past each cusp. To help them along, use the finger indicated on the label to press the corresponding key:\n -Right thumb (R1) on H.\n -Right fingers (R2-R5) on 7,8,9,0.\n -Left thumb (L1) on F.\n -Left fingers (L2-L5) on 4,3,2,1.\n\nAs you become more successful, your score will go up, and so will the number of characters that you must simultaneously mangage. Get your score up to 100, and you win!\n\nThere are options at the bottom of the screen to customize which fingers you use and to adjust the tempo. Good luck! \n\n'); character=[]; ">How to play</button><br>
            <button onclick="stopNow=true">Stop</button><br>
        </div>
        <div id="controls">
            
            <label>Controls
                <select id="key0" onchange="updateControls(0)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key1" onchange="updateControls(1)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key2" onchange="updateControls(2)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key3" onchange="updateControls(3)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key4" onchange="updateControls(4)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key5" onchange="updateControls(5)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key6" onchange="updateControls(6)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key7" onchange="updateControls(7)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key8" onchange="updateControls(8)"><option value="?/">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                <select id="key9" onchange="updateControls(9)"><option value="??">??</option><option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option><option value="R4">R4</option><option value="R5">R5</option><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option><option value="L4">L4</option><option value="L5">L5</option></select>
                
            </label>
            
            <label for="tempoSlider" style="white-space:nowrap">Tempo
                <input type="range" min="100" max="200" value="150" step="5" class="slider" id="tempoSlider" oninput="this.nextElementSibling.value = this.value; bpm = this.value;">
                <output id="tempoSliderValue"></output>
            </label>
            
            

            
        </div>
    </div>



    

    
    
    
    <script>
        var character,part,rhythm,composite;
        var prevTime,prevBeat,curBeat,curTime;
        var lineHeight,lineFade;
        var zeroPitch,bpm;
        var chanceUser;
        var windowLeft,windowRight,windowBottom,windowTop;
        var stopNow;

        function updateControls(n){
            for(let i=0;i<part.length;i++){
                if(i!=n && document.getElementById('key'+i).value==document.getElementById('key'+n).value){
                    document.getElementById('key'+i).value="??";
                }
                switch(document.getElementById('key'+i).value){
                    case "R1": part[i].key="h"; break;
                    case "R2": part[i].key="7"; break;
                    case "R3": part[i].key="8"; break;
                    case "R4": part[i].key="9"; break;
                    case "R5": part[i].key="0"; break;
                    case "L1": part[i].key="f"; break;
                    case "L2": part[i].key="4"; break;
                    case "L3": part[i].key="3"; break;
                    case "L4": part[i].key="2"; break;
                    case "L5": part[i].key="1"; break;
                    case "??": part[i].key=null; break;
                }
                part[i].hand=document.getElementById('key'+i).value.charAt(0);
                part[i].finger=document.getElementById('key'+i).value.charAt(1);
            }
        }
        
        function loadCanon(){
            composite = {rhythm:[], period:0, melody:[], synth:new Synth(new Timbre("sine",220,0.001), null, new Envelope([1,1,0],[.01,.05,.06]), .1, 0)};
            //document.getElementById("controls").style="height: 300px; position: fixed; top: 0%; margin-top: 0px;";
            zeroPitch = 220; bpm = 150;
            switch(document.getElementById("selectedCanon").value){
                case "level1": 
                    rhythm = [0,1,4,5]
                    part=[
                        new Part(new Score(1,0,16,[0,6,7,0],4,[-2,4,5,-2],4),null,null,null),
                        new Part(new Score(1,2,16,[6,12,13,6],4,[-2,4,5,-2],4),null,null,null),
                        new Part(new Score(1,8,16,[1,7,8,1],4,[-2,4,5,-2],4),null,null,null),
                        new Part(new Score(1,10,16,[7,13,14,7],4,[-2,4,5,-2],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R3";
                    document.getElementById('key3').value="L3";
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
                    composite.period=16; 
                    composite.melody=[0,6,6,12,7,0,13,6,1,7,7,13,8,1,14,7];
                    windowLeft = -4; windowRight = 8; windowBottom = -6; windowTop = 20;
                    break;
                case "level2": 
                    rhythm = [0,2,4]
                    part=[
                        new Part(new Score(1,0,12,[7,4,0],4,[5,2,-2],4),null,null,null),
                        new Part(new Score(1,3,12,[10,7,3],4,[5,2,-2],4),null,null,null),
                        new Part(new Score(1,6,12,[13,10,6],4,[5,2,-2],4),null,null,null),
                        new Part(new Score(1,9,12,[16,13,9],4,[5,2,-2],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R3";
                    document.getElementById('key3').value="L3";
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11];
                    composite.period=12; 
                    composite.melody=[7,9,4,10,0,7,13,3,10,16,6,13];
                    windowLeft = -4; windowRight = 8; windowBottom = -6; windowTop = 20;
                    break;
                case "level3": 
                    rhythm = [0,1,2,4,8]
                    part=[
                        new Part(new Score(1,0,15,[0,6,0,11,9],4,[-2,4,-2,9,7],4),null,null,null),
                        new Part(new Score(1,5,15,[4,10,4,15,13],4,[-2,4,-2,9,7],4),null,null,null),
                        new Part(new Score(1,10,15,[8,14,8,19,17],4,[-2,4,-2,9,7],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="R2";
                    document.getElementById('key2').value="R3";
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];
                    composite.period=15; 
                    composite.melody=[0,6,0,17,11,4,10,4,9,15,8,14,8,13,19];
                    windowLeft = -6; windowRight = 10; windowBottom = -6; windowTop = 20;
                    break;
                case "level4": 
                    rhythm = [0,2,4,8,9]
                    part=[
                        new Part(new Score(1,0,13,[17,12,9,10,16],4,[9,4,1,2,8],4),null,null,null),
                        new Part(new Score(1,3,13,[11,6,3,4,10],4,[9,4,1,2,8],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    composite.rhythm=[0,2,3,4,5,7,8,9,11,12];
                    composite.period=13; 
                    composite.melody=[17,12,11,9,6,3,10,16,4,10];
                    windowLeft = -4; windowRight = 13; windowBottom = -2; windowTop = 23;
                    break;
                case "level5": 
                    rhythm = [0,5,6,11]
                    part=[
                        new Part(new Score(1,5,19,[1,5,0,4],4,[-5,-1,-6,-2],4),null,null,null),
                        new Part(new Score(1,8,19,[5,9,4,8],4,[-5,-1,-6,-2],4,),null,null,null),
                        new Part(new Score(1,15,19,[-3,1,-4,0],4,[-5,-1,-6,-2],4),null,null,null),
                        new Part(new Score(1,17,19,[9,13,8,12],4,[-5,-1,-6,-2],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R4";
                    document.getElementById('key3').value="L4";
                    composite.rhythm=[0,1,2,3,4,5,7,8,9,10,11,13,14,15,16,17];
                    composite.period=19; 
                    composite.melody=[8,1,-4,13,8,1,0,5,12,5,0,9,4,-3,4,9];
                    windowLeft = -6; windowRight = 14; windowBottom = -8; windowTop = 16;
                    break;

                case "Popham": 
                    rhythm = [0,3,5,6,8]
                    part=[
                        new Part(new Score(1,0,22,[0,9,2,5,12],4,[-2,7,0,3,10],4),null,null,null),
                        new Part(new Score(1,4,22,[2,11,4,7,14],4,[-2,7,0,3,10],4,),null,null,null),
                        new Part(new Score(1,11,22,[5,14,7,10,17],4,[-2,7,0,3,10],4),null,null,null),
                        new Part(new Score(1,15,22,[3,12,5,8,15],4,[-2,7,0,3,10],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R4";
                    document.getElementById('key3').value="L4";
                    composite.rhythm=[0,1,3,4,5,6,7,8,9,10,11,12,14,15,16,17,18,19,20,21];
                    composite.period=22; 
                    composite.melody=[0,15,9,2,2,5,11,12,4,7,5,14,14,3,7,10,12,17,5,8];
                    windowLeft = -4; windowRight = 12; windowBottom = -6; windowTop = 21;
                    break;
                case "Bennett": 
                    rhythm = [0,5,8,10]
                    part=[
                        new Part(new Score(1,0,22,[0,3,10,7],4,[-2,1,8,5],4),null,null,null),
                        new Part(new Score(1,4,22,[4,7,14,11],4,[-2,1,8,5],4,),null,null,null),
                        new Part(new Score(1,11,22,[2,5,12,9],4,[-2,1,8,5],4),null,null,null),
                        new Part(new Score(1,15,22,[6,9,16,13],4,[-2,1,8,5],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R4";
                    document.getElementById('key3').value="L4";
                    composite.rhythm=[0,1,3,4,5,8,9,10,11,12,14,15,16,19,20,21];
                    composite.period=22; 
                    composite.melody=[0,16,13,4,3,10,7,7,2,14,11,6,5,12,9,9];
                    windowLeft = -4; windowRight = 14; windowBottom = -6; windowTop = 20;
                    break;
                case "Algarin": 
                    rhythm = [0,6,7,13]
                    part=[
                        new Part(new Score(1,0,20,[0,7,4,12],4,[-2,5,2,10],4),null,null,null),
                        new Part(new Score(1,2,20,[4,11,8,16],4,[-2,5,2,10],4,),null,null,null),
                        new Part(new Score(1,4,20,[2,9,6,14],4,[-2,5,2,10],4),null,null,null),
                        new Part(new Score(1,12,20,[5,12,9,17],4,[-2,5,2,10],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R4";
                    document.getElementById('key3').value="L4";
                    composite.rhythm=[0,2,4,5,6,7,8,9,10,11,12,13,15,17,18,19];
                    composite.period=20; 
                    composite.melody=[0,4,2,17,7,4,11,8,9,6,5,12,16,14,12,9];
                    windowLeft = -4; windowRight = 17; windowBottom = -6; windowTop = 21;
                    break;
                case "Grizzle": 
                    rhythm = [0,3,6,11]
                    part=[
                        new Part(new Score(1,0,17,[0,5,7,12],4,[-2,3,5,10],4),null,null,null),
                        new Part(new Score(1,1,17,[3,8,10,15],4,[-2,3,5,10],4,),null,null,null),
                        new Part(new Score(1,2,17,[5,13,15,20],4,[-2,3,5,10],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R4";
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,11,12,13];
                    composite.period=17; 
                    composite.melody=[0,3,5,5,8,13,7,10,15,12,15,20];
                    windowLeft = -4; windowRight = 15; windowBottom = -6; windowTop = 17;
                    break;
                case "Hancock": 
                    rhythm = [0,1,4,8]
                    part=[
                        new Part(new Score(1,2,22,[1,4,5,9],4,[-2,1,2,6],4),null,null,null),
                        new Part(new Score(1,4,22,[0,3,4,8],4,[-2,1,2,6],4,),null,null,null),
                        new Part(new Score(1,13,22,[6,10,11,15],4,[-2,1,2,6],4),null,null,null),
                        new Part(new Score(1,15,22,[5,8,9,13],4,[-2,1,2,6],4),null,null,null),
                    ];
                    document.getElementById('key0').value="R1";
                    document.getElementById('key1').value="L1";
                    document.getElementById('key2').value="R4";
                    document.getElementById('key3').value="L4";
                    composite.rhythm=[1,2,3,4,5,6,8,10,12,13,14,15,16,17,19,21];
                    composite.period=17; 
                    composite.melody=[13,1,4,0,3,5,4,9,8,6,10,5,8,11,9,15];
                    windowLeft = -4; windowRight = 12; windowBottom = -6; windowTop = 19;
                    break;
                case "vals": 
                    rhythm = [0,2,7,8,11]
                    part=[
                        new Part(new Score(1,0,25,[0,7,8,2,11],4,[0,7,8,2,11],4),"9","R","4"),
                        new Part(new Score(1,2,25,[7,14,15,9,18],4,[0,7,8,2,11],4),"7","R","2"),
                        new Part(new Score(1,7,25,[8,15,16,10,19],4,[0,7,8,2,11],4),"h","R","1"),
                        new Part(new Score(1,8,25,[2,9,10,4,13],4,[0,7,8,2,11],4),"f","L","1"),
                        new Part(new Score(1,11,25,[11,18,19,13,22],4,[0,7,8,2,11],4),"3","L","3")
                    ];
                    composite.rhythm=[0,2,4,7,8,9,10,11,13,14,15,16,18,19,22];
                    composite.period=25; 
                    composite.melody=[0,7,14,8,2,15,9,11,18,16,10,4,19,13,22];
                    windowLeft = -6; windowRight = 14; windowBottom = -4; windowTop = 26;
                    break;
                
                

            }
            updateControls(0);
            chanceUser = 1/part.length;
            document.getElementById("tempoSlider").value = bpm;
            document.getElementById("tempoSliderValue").value=bpm;
        }
        

        
        

        function begin(){
            stopNow=false;
            loadCanon();
            document.getElementById("title").style.display="none";
            document.getElementById("container").style.display="block";
            for (let i = 0;i<10;i++){
                if(i<part.length){
                    document.getElementById("key"+i).style.display="inline";
                }else{
                    document.getElementById("key"+i).style.display="none";
                }
            }
            
            playNote(new Synth(new Timbre("square",2000,10), null, new Envelope([1,1,0],[.01,.2,.3]), 0, 0),0)
            prevTime = new Date().getTime();
            prevBeat = -.9;
            curBeat = -.9;
            curTime = new Date().getTime();
            character = []
            UpdateScreen();

        }
        

        function playNote(synth,freq){
            console.log(freq);
            audioCtx = new AudioContext();
            var mainOsc = audioCtx.createOscillator();
            var mainFilter = audioCtx.createBiquadFilter();
            var mainGainA= audioCtx.createGain();
            var mainGainB = audioCtx.createGain();
            var mainPan = audioCtx.createStereoPanner();
            mainOsc.connect(mainFilter);
            mainFilter.connect(mainGainA);
            mainGainA.connect(mainGainB);
            mainGainB.connect(mainPan);
            mainPan.connect(audioCtx.destination);

            mainOsc.type = synth.timbre.osc;
            
            mainOsc.frequency.value = freq;
            mainFilter.type = "bandpass";
            mainFilter.Q.value=synth.timbre.filterQ;
            mainFilter.frequency.value=synth.timbre.filterFreq;
            mainGainB.gain.value=0;
            mainPan.pan.value=synth.pan;
            now=audioCtx.currentTime;

            mainGainB.gain.setValueAtTime(0,now);
            for(let i=0;i<synth.envelope.gain.length;i++){
                mainGainB.gain.linearRampToValueAtTime(synth.envelope.gain[i],synth.envelope.time[i]);
            }
            mainOsc.start();
            let endNote = now+synth.envelope.time[synth.envelope.time.length-1]+.1;
            mainOsc.stop(endNote);
             
            mainGainA.gain.value=synth.gain;
            if(synth.lfo != null){
                var lfoOsc = audioCtx.createOscillator();
                var lfoGain = audioCtx.createGain();
                lfoOsc.connect(lfoGain);
                if(synth.lfo.type=="vib"){
                    lfoGain.connect(mainOsc.detune);
                    lfoGain.gain.value=synth.lfo.amp;
                } else {
                    lfoGain.connect(mainGainA.gain);
                    mainGainA.gain.value=synth.gain*(1-synth.lfo.amp/2);
                    lfoGain.gain.value=synth.gain*synth.lfo.amp/2;
                }
                
                lfoOsc.type=synth.lfo.osc;
                lfoOsc.frequency.value=synth.lfo.freq;
                lfoOsc.start();
                lfoOsc.stop(endNote);
            }            
        }




        
        var canvas = document.getElementById("myCanvas");
        var c = canvas.getContext("2d");

        function Character(part,iteration,status,nextNote,xPos,yPos,user,synth,deadFade){
            this.part=part;
            this.iteration=iteration;
            this.status=status; 
            this.nextNote=nextNote;
            this.xPos=xPos;
            this.yPos=yPos;
            this.user=user;
            this.synth=synth;
            this.deadFade=deadFade;
            this.prevNote = function () {
                if (this.part.score.aug>0){
                    return this.nextNote-1;
                } else {
                    return this.nextNote+1;
                }
            }
            this.PositionY = function(melodyOrBase) {
                if (melodyOrBase=="melody"){
                    melodyOrBase=this.part.score.melody;
                    dip=this.part.score.mDip;
                } else {
                    melodyOrBase=this.part.score.base;
                    dip=this.part.score.bDip;
                }
                if((this.part.score.aug>0 && this.nextNote==0) || (this.part.score.aug<0 && this.nextNote==-1)){
                    x1=windowLeft;
                    if(dip>0){y1=windowBottom+melodyOrBase[0]-this.part.score.base[0]}else{y1=windowTop-melodyOrBase[0]+this.part.score.base[0]}
                    x2=rhythm[0]-1;
                    y2=y1;
                    x3=rhythm[0];
                    y3=melodyOrBase[0];
                }else if((this.part.score.aug>0 && this.nextNote==rhythm.length) || (this.part.score.aug<0 && this.nextNote==rhythm.length-1)){
                    x1=rhythm[rhythm.length-1];
                    y1=melodyOrBase[rhythm.length-1];
                    x2=rhythm[rhythm.length-1]+1;
                    if(dip>0){y2=windowBottom+melodyOrBase[0]-this.part.score.base[0]}else{y2=windowTop-melodyOrBase[0]+this.part.score.base[0]}
                    x3=windowRight;
                    y3=y2;
                }else {
                    x1=rhythm[this.prevNote()];
                    y1=melodyOrBase[this.prevNote()];
                    x3=rhythm[this.nextNote];
                    y3=melodyOrBase[this.nextNote];
                    x2=(x1+x3)/2;
                    if(this.part.score.mDip>0){
                        y2=Math.min(y1,y3)-dip;
                    } else {
                        y2=Math.max(y1,y3)-dip;
                    }
                }
                return quadraticFunction(x1,y1,x2,y2,x3,y3,this.xPos);
            }
            this.update = function () {
                

                xOld = PositionX(this.part,prevBeat,this.iteration);
                xNew = PositionX(this.part,curBeat,this.iteration);
                
                if(this.status=="dead"){
                    this.deadFade=this.deadFade*.9;
                } else if(this.user){
                    if(xNew>windowRight+.5 || xNew<windowLeft-.5){
                        this.status="done";

                    } else if(inInterval(rhythm[this.nextNote]-.4/this.part.score.aug,xOld,xNew)){
                        if(this.status=="traveling"){this.status="prebeat1";}
                    } else if(inInterval(rhythm[this.nextNote],xOld,xNew)){
                        if(this.status=="prebeat1"){
                            this.status="postbeat";
                        } else if(this.status=="prebeat2"){
                            this.status="traveling";
                            this.nextNote=this.nextNote+Math.sign(this.part.score.aug);
                        }
                    } else if(inInterval(rhythm[this.nextNote]+.4/this.part.score.aug,xOld,xNew)){
                        if(this.status!=="traveling"){
                            this.status="dead";
                            changeChance(-1);
                        }
                    }
                    if(this.status=="traveling" || this.status=="prebeat1"){
                        this.xPos = xNew;
                        this.yPos = this.PositionY("melody");
                    } else {
                        this.xPos = rhythm[this.nextNote];
                        this.yPos = this.part.score.melody[this.nextNote];
                    } 
                }else{
                    if(xNew>windowRight+.5 || xNew<windowLeft-.5){
                        this.status="done";
                    } else if(inInterval(rhythm[this.nextNote],xOld,xNew)){
                        console.log("auto");
                        playNote(this.synth,zeroPitch*Math.pow(2,this.part.score.melody[this.nextNote]/12));
                        this.xPos = rhythm[this.nextNote];
                        this.yPos = this.part.score.melody[this.nextNote];
                        this.nextNote=this.nextNote+Math.sign(this.part.score.aug);
                    } else {
                        this.xPos = xNew;
                        this.yPos = this.PositionY("melody");
                    }
                }
            };
            
        }
        function changeChance(d){
            if(d>0){
                chanceUser=chanceUser+1/Math.pow(part.length,2);
            } else {
                chanceUser=Math.max(1/part.length,chanceUser-1/part.length);
            }
        }
        function quadraticFunction(x1,y1,x2,y2,x3,y3,x){

            let a=x1-2*x2+x3;
            let b=-2*x1+2*x2;
            let c=x1-x;
            var t;
            if(a==0){
                t=-c/b;
            } else{
                t=(-b+Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);
            }
            return Math.pow(1-t,2)*y1+2*(1-t)*t*y2+Math.pow(t,2)*y3;
        }

        function PositionX(p,b,i){
            return (b-p.score.trans-i*p.score.period)/p.score.aug;
        }


        
        document.addEventListener('keydown', logKey);

        function logKey(e) {
            for(let i=0;i<character.length;i++){
                if(character[i].part.key==e.key){
                    if(character[i].status=="prebeat1"){
                        changeChance(1);
                        playNote(character[i].synth,zeroPitch*Math.pow(2,character[i].part.score.melody[character[i].nextNote]/12));
                        character[i].status="prebeat2";
                    } else if(character[i].status=="postbeat"){
                        changeChance(1);
                        playNote(character[i].synth,zeroPitch*Math.pow(2,character[i].part.score.melody[character[i].nextNote]/12));
                        character[i].status="traveling";
                        character[i].nextNote=character[i].nextNote+Math.sign(character[i].part.score.aug);
                    } else if(character[i].status=="traveling" && character[i].xPos>Math.min(...rhythm)-1.5 && character[i].xPos<Math.max(...rhythm)){
                        character[i].status="dead";
                        changeChance(-1);
                    }
                }
            }

        }
        

        function inInterval(a,b,c){
            if(a>=Math.min(b,c) && a<Math.max(b,c)){
                return true;
            } else {
                return false;
            }
        }

        function scaleX(x){
            return (x-windowLeft)/(windowRight-windowLeft)*canvas.width;
        }
        function scaleY(y){
            return (windowTop-y)/(windowTop-windowBottom)*canvas.height;
        }

        function drawEverything(){
            c.beginPath();
            c.moveTo(0,scaleY(lineHeight));
            c.lineTo(canvas.width,scaleY(lineHeight));
            lineFade=lineFade*.9;
            c.globalAlpha=lineFade;
            c.stroke();
            c.globalAlpha=1;
            var cx;
            var cy;
            var nx;
            var ny;
            var x0, y0;
            for(let i=0;i<part.length;i++){
                
                c.beginPath();
                nx=windowLeft;
                if(part[i].score.bDip>0){ny=windowBottom;} else {ny=windowTop;}
                c.moveTo(scaleX(nx), scaleY(ny));
                cx=rhythm[0]-1;
                cy=ny;
                nx=rhythm[0];
                ny=part[i].score.base[0];
                c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                for(let j=1;j<rhythm.length;j++){
                    cx=(rhythm[j-1]+rhythm[j])/2;
                    if(part[i].score.bDip>0){
                        cy=Math.min(part[i].score.base[j-1],part[i].score.base[j])-part[i].score.bDip;
                    } else{
                        cy=Math.max(part[i].score.base[j-1],part[i].score.base[j])-part[i].score.bDip;
                    }
                    nx=rhythm[j];
                    ny=part[i].score.base[j];
                    c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                }
                cx=rhythm[rhythm.length-1]+1;
                if(part[i].score.bDip>0){cy=windowBottom;} else {cy=windowTop;}
                nx=windowRight;
                ny=cy;
                c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                c.stroke(); 
            }
            var r;
            for(let i=0;i<character.length;i++){
                x0=scaleX(character[i].xPos);
                y0=scaleY(character[i].yPos);
                if (character[i].status=="dead"){
                    c.globalAlpha=character[i].deadFade;
                    c.beginPath();
                    c.moveTo(x0 , y0);
                    c.lineTo(x0 , scaleY(character[i].PositionY("base")));
                    c.stroke();
                    c.beginPath();
                    c.moveTo(x0-10, y0-10);
                    c.lineTo(x0+10, y0+10);
                    c.stroke();
                    c.beginPath();
                    c.moveTo(x0+10, y0-10);
                    c.lineTo(x0-10, y0+10);
                    c.stroke();
                    c.globalAlpha=1;
                } else {
                    c.beginPath();
                    c.moveTo(x0 , y0);
                    c.lineTo(x0 , scaleY(character[i].PositionY("base")));
                    c.stroke();
                    c.beginPath();
                    c.arc(x0,y0,14,0,6.3);
                    c.fillStyle = "White";
                    c.fill();
                    c.stroke();
                    if(character[i].user){
                        if(character[i].part.hand=="L"){
                            r=1;
                        } else {
                            r=-1;
                        }
                        c.beginPath();
                        c.moveTo(x0-14*r,y0-9);
                        c.lineTo(x0-19*r,y0-29);
                        c.lineTo(x0-15*r,y0-30);
                        c.lineTo(x0-9*r,y0-14);
                        c.lineTo(x0-14*r,y0-9);
                        if(character[i].part.finger==5){c.fillStyle = "Black";} else { c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0-1*r,y0-17);
                        c.lineTo(x0-2*r,y0-41);
                        c.lineTo(x0-7*r,y0-41);
                        c.lineTo(x0-7*r,y0-15);
                        c.lineTo(x0-1*r,y0-17);
                        if(character[i].part.finger==4){c.fillStyle = "Black";} else { c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0+6*r,y0-15);
                        c.lineTo(x0+7*r,y0-43);
                        c.lineTo(x0+1*r,y0-44);
                        c.lineTo(x0+0*r,y0-17);
                        c.lineTo(x0+6*r,y0-15);
                        if(character[i].part.finger==3){c.fillStyle = "Black";} else { c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0+13*r,y0-11);
                        c.lineTo(x0+17*r,y0-37);
                        c.lineTo(x0+12*r,y0-38);
                        c.lineTo(x0+7*r,y0-15);
                        c.lineTo(x0+13*r,y0-11);
                        if(character[i].part.finger==2){c.fillStyle = "Black";} else { c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.beginPath();
                        c.moveTo(x0+14*r,y0+10);
                        c.lineTo(x0+30*r,y0-9);
                        c.lineTo(x0+27*r,y0-13);
                        c.lineTo(x0+17*r,y0-3);
                        c.lineTo(x0+14*r,y0+10);
                        if(character[i].part.finger==1){c.fillStyle = "Black";} else { c.fillStyle = "White";}
                        c.fill();
                        c.stroke();
                        c.font = "14px Arial";
                        c.textAlign = "center";
                        c.textBaseline = "middle";
                        c.fillStyle = "Black";
                        c.fillText(character[i].part.hand+character[i].part.finger, scaleX(character[i].xPos) , scaleY(character[i].yPos)); 
                    }
                }
                
            }
            
        }

        function SpawnNewCharacter(p){
            
            var spawnPoint;
            var nextNote;
            if(p.score.aug>0){
                spawnPoint = windowLeft;
                nextNote = 0;
            } else {
                spawnPoint = windowRight;
                nextNote = rhythm.length-1;
            }
            let i = Math.round((spawnPoint*p.score.aug-curBeat+p.score.trans)/-p.score.period);
            if(inInterval(spawnPoint,PositionX(p,curBeat,i),PositionX(p,prevBeat,i))){
                var user, curUser=0;
                if(character.length==0){
                    user = Math.random()<=chanceUser;
                } else {
                    for(let j=0;j<character.length;j++){
                        if (character[j].user==true){curUser++}
                    }
                    user = Math.random()<=chanceUser - .5*(curUser/character.length-chanceUser);
                }
                if(user || Math.random()<.5){
                    let osc=Math.random();
                    if(osc<.5){
                        osc="square";
                    } else {
                        osc="sawtooth";
                    }
                    let midrange=(Math.max(...p.score.melody)+Math.min(...p.score.melody))/2;
                    let filterFreq=zeroPitch*Math.pow(2,midrange/12+4*Math.random());
                    let filterQ=10;
                    let envChoice=Math.floor(Math.random()*7.99);
                    var envGain;
                    var envTime;
                    switch(envChoice) {
                    case 0: envGain=[1,1,0]; envTime=[.01,.2,.3]; break; // regular attack, short sustain, regular release
                    case 1: envGain=[1,1,0]; envTime=[.01,.2,.7]; break; // regular attack, short sustain, decay
                    case 2: envGain=[3,1,1,0]; envTime=[.01,.05,.2,.3]; break; // hard attack, short sustain, regular release
                    case 3: envGain=[3,1,1,0]; envTime=[.01,.05,.2,.7]; break; // hard attack, short sustain, decay
                    case 4: envGain=[1,1,0]; envTime=[.1,.2,.3]; break; // soft attack, short sustain, regular release
                    case 5: envGain=[1,1,0]; envTime=[.1,.2,.7]; break; // soft attack, short sustain, decay
                    case 6: envGain=[3,2,0]; envTime=[.01,.14,.15]; break; 
                    case 7: envGain=[3,0]; envTime=[.14,.15]; break;
                    default: envGain=[1,1,0]; envTime=[.01,.2,.3]; break; 
                    } 
                    var lfoType,lfoOsc,lfoFreq,lfoAmp;
                    
                    if(Math.random()<.5){
                        if(Math.random()<.5){
                            lfoType="vib";
                            lfoFreq=6*Math.pow(2,Math.random());
                            lfoOsc="sine";
                            lfoAmp=5+Math.random()*20;
                            lfoShift=0;
                        }else{
                            lfoType="trem";
                            lfoFreq=10*Math.pow(2,Math.random());
                            if(Math.random()<.5){
                                lfoOsc="sine";
                                lfoAmp=.1+.9*Math.random();
                            } else {
                                lfoOsc="square";
                                lfoAmp=1;
                            }
                        }
                    } else {
                        lfoType="none";
                    }
                    
                    
                    if(user){
                        gain=.8;
                    } else {
                        gain=.2;
                    }
                    let pan=Math.random()*2-1;
                    if(lfoType=="none"){
                        character.push(new Character(p,i,"traveling",nextNote,0,0,user, new Synth(new Timbre(osc,filterFreq,filterQ), null, new Envelope(envGain,envTime), gain, pan),1));
                    } else {
                        character.push(new Character(p,i,"traveling",nextNote,0,0,user, new Synth(new Timbre(osc,filterFreq,filterQ), new Lfo(lfoType,lfoOsc,lfoFreq,lfoAmp), new Envelope(envGain,envTime), gain, pan),1));
                    }
                        
                }
            }
        }

        function UpdateScreen(){
            let score =Math.round((chanceUser-1/part.length)/part.length*1000)/10;
            if(score>=100){
                document.getElementById("currentScore").innerText='Score\n100';
                alert('YOU WIN!');
                stopNow=true;
            } else {
                document.getElementById("currentScore").innerText='Score\n' + score;
            }
            prevTime=curTime;
            curTime=new Date().getTime();
            prevBeat = curBeat;
            curBeat = curBeat+bpm/60*.001*(curTime-prevTime);
            canvas.height=window.innerHeight*.95;
            canvas.width=window.innerWidth;
            var e1;
            var e2;
            for(let i=0;i<composite.rhythm.length;i++){
                e1=((prevBeat+.5) % composite.period)-.5;
                e2=((curBeat+.5) % composite.period)-.5;
                if(e1<composite.rhythm[i] && composite.rhythm[i]<=e2){
                    console.log("c"+i);
                    playNote(composite.synth,zeroPitch*Math.pow(2, composite.melody[i]/12));
                    lineHeight=composite.melody[i];
                    lineFade=1;
                    break;
                }
            }
            
            for(let i=0;i<part.length;i++){
               SpawnNewCharacter(part[i]);
            }
            //if(document.hasFocus==false){character=[]}
            for(let i=0;i<character.length;i++){
               character[i].update();
               if (character[i].deadFade<.1 || character[i].status=="done"){
                   character.splice(i, 1);
                   i=i-1;
               }
            }
            drawEverything();
            if(!document.hidden && !stopNow){
                requestAnimationFrame(UpdateScreen);
            } else {
                character=[];
                c.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById("title").style.display="block";
                document.getElementById("container").style.display="none";
            }
            
        }
    

        
        function Score(aug,trans,period,melody,mDip,base,bDip,fillColor,textColor){
            this.aug = aug;
            this.trans = trans;
            this.period = period;
            this.melody = melody;
            this.mDip = mDip;
            this.base = base;
            this.bDip = bDip;
            this.fillColor = fillColor;
            this.textColor = textColor;
        }

        function Timbre(osc,filterFreq,filterQ){
            this.osc = osc;
            this.filterFreq = filterFreq;
            this.filterQ = filterQ;
        }
        function Lfo(type,osc,freq,amp){
            this.type = type;
            this.osc = osc;
            this.freq = freq;
            this.amp = amp;
        }
        function Envelope(gain,time){
            this.gain = gain;
            this.time = time;
        }
        function Synth(timbre,lfo,envelope,gain,pan){
            this.timbre = timbre;
            this.lfo = lfo;
            this.envelope = envelope;
            this.gain = gain;
            this.pan = pan;
        }
        function Part(score,key,hand,finger) {
            this.score = score;
            this.key = key;
            this.hand = hand;
            this.finger = finger;
        }
        
        
        

        
        
        

    </script>
</body>
</html>