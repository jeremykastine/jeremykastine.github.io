<!-- scheme for colors left vs right
 -->


<!DOCTYPE html>
<html lang="en">





<head>
    <meta charset="UTF-8">
    <title>Can you canon?</title>
    <style type="text/css">
        canvas {
            position: fixed;
        }
    </style>
    
</head>
<body> 
    <canvas id="myCanvas" style="z-index:-1"> </canvas>
    <div id="title" style="text-align: center;">
        <h1>Can you canon?</h1>
        <h2>A rhythmic canon game by Jeremy Kastine</h2>
        <label>Select a canon: </label>
        <select id="selectedCanon" onchange="playNote(new Synth(new Timbre('square',2000,10), null, new Envelope([1,1,0],[.01,.2,.3]), 0, 0),0);">
            <option value="tiling1">Full Tiling</option>
            <option value="maxeven1">Maximally Even Tiling</option>
            <option value="vals">Val's S-Canon</option>
        </select>
        <button onclick="begin()">Start</button>
    </div>
    <div id="controls" style="display:none;">
        <p id="directions">
            
        </p>
        <div class="slidecontainer">
            <label for="spawnSlider">Probability of character spawning</label><br>
            <input type="range" min="0" max="1" value=".5" step=".05" class="slider" id="spawnSlider" oninput="this.nextElementSibling.value = this.value; chanceSpawn=this.value;">
            <output id="spawnSliderValue"></output>
        </div>
        <div class="slidecontainer">
            <label for="userSlider">Probability of user-controlled</label><br>
            <input type="range" min="0" max="1" value=".5" step=".05" class="slider" id="userSlider" oninput="this.nextElementSibling.value = this.value; chanceUser=this.value;">
            <output id="userSliderValue"></output>
        </div>
        <div class="slidecontainer">
            <label for="tempoSlider">Tempo</label><br>
            <input type="range" min="100" max="200" value="150" step="5" class="slider" id="tempoSlider" oninput="this.nextElementSibling.value = this.value; bpm = this.value;">
            <output id="tempoSliderValue"></output>
        </div>
        <button onclick="stopNow=true">Stop</button>
    </div>
    






    
    
    
    <script>
        var character,part,rhythm,composite;
        var prevTime,prevBeat,curBeat,curTime;
        var lineHeight,lineFade;//for composite
        var zeroPitch,bpm;
        var chanceSpawn,chanceUser;
        var windowLeft,windowRight,windowBottom,windowTop;
        var stopNow;


        function loadCanon(){
            document.getElementById("directions").innerHTML="Finger placement on keyboard:<ul><li>Place your right thumb (R1) on H.</li><li>Place your right fingers (R2-R5) on 7,8,9,0.</li><li>Place your left thumb (L1) on F.</li><li>Place your left fingers (L2-L5) on 4,3,2,1.</li></ul>";
            composite = {rhythm:[], period:0, melody:[], synth:new Synth(new Timbre("sine",220,0.001), null, new Envelope([1,1,0],[.01,.05,.06]), .2, 0)};
            document.getElementById("controls").style="height: 300px; position: fixed; top: 0%; margin-top: 0px;";
            zeroPitch = 220; chanceSpawn = .75; chanceUser = .5; bpm = 150;
            switch(document.getElementById("selectedCanon").value){
                case "tiling1": 
                    rhythm = [0,1,2,4,8]
                    part=[
                        new Part(new Score(1,0,15,[0,6,0,11,9],4,[-2,4,-2,9,7],4,"LightBlue","Black"),"h","R1"),
                        new Part(new Score(1,5,15,[4,10,4,15,13],4,[-2,4,-2,9,7],4,"DarkBlue","White"),"f","L1"),
                        new Part(new Score(1,10,15,[8,14,8,19,17],4,[-2,4,-2,9,7],4,"LightPink","Black"),"9","R4"),
                    ];
                    composite.rhythm=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];
                    composite.period=15; 
                    composite.melody=[0,6,0,17,11,4,10,4,9,15,8,14,8,13,19];
                    windowLeft = -6; windowRight = 10; windowBottom = -6; windowTop = 20;
                    break;
                case "vals": 
                    rhythm = [0,2,7,8,11]
                    part=[
                        new Part(new Score(1,0,25,[0,7,8,2,11],4,[0,7,8,2,11],4,"LightBlue","Black"),"9","R4"),
                        new Part(new Score(1,2,25,[7,14,15,9,18],4,[0,7,8,2,11],4,"LightPink","Black"),"7","R2"),
                        new Part(new Score(1,7,25,[8,15,16,10,19],4,[0,7,8,2,11],4,"Orange","Black"),"h","R1"),
                        new Part(new Score(1,8,25,[2,9,10,4,13],4,[0,7,8,2,11],4,"Purple","Black"),"f","L1"),
                        new Part(new Score(1,11,25,[11,18,19,13,22],4,[0,7,8,2,11],4,"LightGreen","Black"),"3","L3")
                    ];
                    composite.rhythm=[0,2,4,7,8,9,10,11,13,14,15,16,18,19,22];
                    composite.period=25; 
                    composite.melody=[0,7,14,8,2,15,9,11,18,16,10,4,19,13,22];
                    windowLeft = -6; windowRight = 14; windowBottom = -4; windowTop = 26;
                    break;
                case "maxeven1": 
                    rhythm = [0,5,6,11]
                    part=[
                        new Part(new Score(1,5,19,[1,5,0,4],4,[-5,-1,-6,-2],4,"hsl(0, 100%, 75%)","Black"),"h","R1"),
                        new Part(new Score(1,8,19,[5,9,4,8],4,[-5,-1,-6,-2],4,"hsl(0, 100%, 25%)","White"),"f","L1"),
                        new Part(new Score(1,15,19,[-3,1,-4,0],4,[-5,-1,-6,-2],4,"hsl(180, 100%, 75%)","Black"),"9","R4"),
                        new Part(new Score(1,17,19,[9,13,8,12],4,[-5,-1,-6,-2],4,"hsl(180, 100%, 25%)","White"),"2","L4"),
                    ];
                    composite.rhythm=[0,1,2,3,4,5,7,8,9,10,11,13,14,15,16,17];
                    composite.period=19; 
                    composite.melody=[8,1,-4,13,8,1,0,5,12,5,0,9,4,-3,4,9];
                    windowLeft = -6; windowRight = 14; windowBottom = -8; windowTop = 16;
                    break;

            }
            document.getElementById("spawnSlider").value = chanceSpawn;
            document.getElementById("spawnSliderValue").value=chanceSpawn;
            document.getElementById("userSlider").value = chanceUser;
            document.getElementById("userSliderValue").value=chanceUser;
            document.getElementById("tempoSlider").value = bpm;
            document.getElementById("tempoSliderValue").value=bpm;
        }
        

        
        

        function begin(){
            stopNow=false;
            loadCanon();
            document.getElementById("title").style.display="none";
            document.getElementById("controls").style.display="block";
            playNote(new Synth(new Timbre("square",2000,10), null, new Envelope([1,1,0],[.01,.2,.3]), 0, 0),0)
            prevTime = new Date().getTime();
            prevBeat = -.9;
            curBeat = -.9;
            curTime = new Date().getTime();
            character = []
            UpdateScreen();

        }
        

        function playNote(synth,freq){
            console.log(synth);
            audioCtx = new AudioContext();
            var mainOsc = audioCtx.createOscillator();
            var mainFilter = audioCtx.createBiquadFilter();
            var mainGainA= audioCtx.createGain();
            var mainGainB = audioCtx.createGain();
            var mainPan = audioCtx.createStereoPanner();
            mainOsc.connect(mainFilter);
            mainFilter.connect(mainGainA);
            mainGainA.connect(mainGainB);
            mainGainB.connect(mainPan);
            mainPan.connect(audioCtx.destination);

            mainOsc.type = synth.timbre.osc;
            
            mainOsc.frequency.value = freq;
            mainFilter.type = "bandpass";
            mainFilter.Q.value=synth.timbre.filterQ;
            mainFilter.frequency.value=synth.timbre.filterFreq;
            mainGainB.gain.value=0;
            mainPan.pan.value=synth.pan;
            now=audioCtx.currentTime;

            mainGainB.gain.setValueAtTime(0,now);
            for(let i=0;i<synth.envelope.gain.length;i++){
                mainGainB.gain.linearRampToValueAtTime(synth.envelope.gain[i],synth.envelope.time[i]);
            }
            mainOsc.start();
            let endNote = now+synth.envelope.time[synth.envelope.time.length-1]+.1;
            mainOsc.stop(endNote);
             
            mainGainA.gain.value=synth.gain;
            if(synth.lfo != null){
                var lfoOsc = audioCtx.createOscillator();
                var lfoGain = audioCtx.createGain();
                lfoOsc.connect(lfoGain);
                if(synth.lfo.type=="vib"){
                    lfoGain.connect(mainOsc.detune);
                } else {
                    lfoGain.connect(mainGainA.gain);
                    mainGainA.gain.value=synth.gain*(1-synth.lfo.amp/2);
                    lfoGain.gain.value=-synth.gain*synth.lfo.amp/2;
                }
                
                lfoOsc.type=synth.lfo.osc;
                lfoOsc.frequency.value=synth.lfo.freq;
                lfoGain.gain.value=synth.lfo.amp;
                lfoOsc.start();
                lfoOsc.stop(endNote);
            }            
        }




        
        var canvas = document.getElementById("myCanvas");
        var c = canvas.getContext("2d");

        function Character(part,iteration,status,nextNote,xPos,yPos,user,synth){
            this.part=part;
            this.iteration=iteration;
            this.status=status; 
            this.nextNote=nextNote;
            this.xPos=xPos;
            this.yPos=yPos;
            this.user=user;
            this.synth=synth;
            this.prevNote = function () {
                if (this.part.score.aug>0){
                    return this.nextNote-1;
                } else {
                    return this.nextNote+1;
                }
            }
            this.PositionY = function(melodyOrBase) {
                if (melodyOrBase=="melody"){
                    melodyOrBase=this.part.score.melody;
                    dip=this.part.score.mDip;
                } else {
                    melodyOrBase=this.part.score.base;
                    dip=this.part.score.bDip;
                }
                if((this.part.score.aug>0 && this.nextNote==0) || (this.part.score.aug<0 && this.nextNote==-1)){
                    x1=windowLeft;
                    y1=windowBottom+melodyOrBase[0]-this.part.score.base[0];
                    x2=rhythm[0]-1;
                    y2=windowBottom+melodyOrBase[0]-this.part.score.base[0];
                    x3=rhythm[0];
                    y3=melodyOrBase[0];
                }else if((this.part.score.aug>0 && this.nextNote==rhythm.length) || (this.part.score.aug<0 && this.nextNote==rhythm.length-1)){
                    x1=rhythm[rhythm.length-1];
                    y1=melodyOrBase[rhythm.length-1];
                    x2=rhythm[rhythm.length-1]+1;
                    y2=windowBottom+melodyOrBase[0]-this.part.score.base[0];
                    x3=windowRight;
                    y3=windowBottom+melodyOrBase[0]-this.part.score.base[0];
                }else {
                    x1=rhythm[this.prevNote()];
                    y1=melodyOrBase[this.prevNote()];
                    x3=rhythm[this.nextNote];
                    y3=melodyOrBase[this.nextNote];
                    x2=(x1+x3)/2;
                    if(this.part.score.mDip>0){
                        y2=Math.min(y1,y3)-dip;
                    } else {
                        y2=Math.max(y1,y3)-dip;
                    }
                }
                return quadraticFunction(x1,y1,x2,y2,x3,y3,this.xPos);
            }
            this.update = function () {
                

                xOld = PositionX(this.part,prevBeat,this.iteration);
                xNew = PositionX(this.part,curBeat,this.iteration);
                if(xNew>windowRight+1 || xNew<windowLeft-1){
                    this.status="dead";
                    return;
                }
                if(this.user){
                    if(inInterval(rhythm[this.nextNote]-.33/this.part.score.aug,xOld,xNew)){
                        if(this.status=="traveling"){this.status="prebeat1";}
                    } else if(inInterval(rhythm[this.nextNote],xOld,xNew)){
                        if(this.status=="prebeat1"){
                            this.status="postbeat";
                        } else if(this.status=="prebeat2"){
                            this.status="traveling";
                            this.nextNote=this.nextNote+Math.sign(this.part.score.aug);
                        }
                    } else if(inInterval(rhythm[this.nextNote]+.33/this.part.score.aug,xOld,xNew)){
                        if(this.status!=="traveling"){
                            this.status="dead";
                        }
                    } else if(xNew>windowRight){
                        this.status="dead";
                    }
                    if(this.status=="traveling" || this.status=="prebeat1"){
                        this.xPos = xNew;
                        this.yPos = this.PositionY("melody");
                    } else {
                        this.xPos = rhythm[this.nextNote];
                        this.yPos = this.part.score.melody[this.nextNote];
                    } 
                }else{
                    if(inInterval(rhythm[this.nextNote],xOld,xNew)){
                        playNote(this.synth,zeroPitch*Math.pow(2,this.part.score.melody[this.nextNote]/12));
                        this.xPos = rhythm[this.nextNote];
                        this.yPos = this.part.score.melody[this.nextNote];
                        this.nextNote=this.nextNote+Math.sign(this.part.score.aug);
                    } else {
                        this.xPos = xNew;
                        this.yPos = this.PositionY("melody");
                    }
                }
            };
            
        }

        function quadraticFunction(x1,y1,x2,y2,x3,y3,x){

            let a=x1-2*x2+x3;
            let b=-2*x1+2*x2;
            let c=x1-x;
            var t;
            if(a==0){
                t=-c/b;
            } else{
                t=(-b+Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);
            }
            return Math.pow(1-t,2)*y1+2*(1-t)*t*y2+Math.pow(t,2)*y3;
        }

        function PositionX(p,b,i){
            return (b-p.score.trans-i*p.score.period)/p.score.aug;
        }


        
        document.addEventListener('keydown', logKey);

        function logKey(e) {
            for(let i=0;i<character.length;i++){
                if(character[i].part.key==e.key){
                    if(character[i].status=="prebeat1"){
                        playNote(character[i].synth,zeroPitch*Math.pow(2,character[i].part.score.melody[character[i].nextNote]/12));
                        character[i].status="prebeat2";
                    } else if(character[i].status=="postbeat"){
                        playNote(character[i].synth,zeroPitch*Math.pow(2,character[i].part.score.melody[character[i].nextNote]/12));
                        character[i].status="traveling";
                        character[i].nextNote=character[i].nextNote+Math.sign(character[i].part.score.aug);
                    } else if(character[i].status=="traveling" && character[i].xPos>Math.min(...rhythm)-1.5 && character[i].xPos<Math.max(...rhythm)){
                        character[i].status="dead";
                    }
                }
            }

        }
        

        function inInterval(a,b,c){
            if(a>=Math.min(b,c) && a<Math.max(b,c)){
                return true;
            } else {
                return false;
            }
        }

        function scaleX(x){
            return (x-windowLeft)/(windowRight-windowLeft)*canvas.width;
        }
        function scaleY(y){
            return (windowTop-y)/(windowTop-windowBottom)*canvas.height;
        }

        function drawEverything(){
            c.beginPath();
            c.moveTo(0,scaleY(lineHeight));
            c.lineTo(canvas.width,scaleY(lineHeight));
            lineFade=lineFade*.9;
            c.globalAlpha=lineFade;
            c.stroke();
            c.globalAlpha=1;
            var cx;
            var cy;
            var nx;
            var ny;
            for(let i=0;i<part.length;i++){
                
                c.beginPath();
                nx=windowLeft;
                ny=windowBottom;
                c.moveTo(scaleX(nx), scaleY(ny));
                cx=rhythm[0]-1;
                cy=windowBottom;
                nx=rhythm[0];
                ny=part[i].score.base[0];
                c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                for(let j=1;j<rhythm.length;j++){
                    cx=(rhythm[j-1]+rhythm[j])/2;
                    if(part[i].score.bDip>0){
                        cy=Math.min(part[i].score.base[j-1],part[i].score.base[j])-part[i].score.bDip;
                    } else{
                        cy=Math.max(part[i].score.base[j-1],part[i].score.base[j])-part[i].score.bDip;
                    }
                    nx=rhythm[j];
                    ny=part[i].score.base[j];
                    c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                }
                cx=rhythm[rhythm.length-1]+1;
                cy=windowBottom;
                nx=windowRight;
                ny=windowBottom;
                c.quadraticCurveTo(scaleX(cx), scaleY(cy), scaleX(nx), scaleY(ny));
                c.stroke(); 
            }
            for(let i=0;i<character.length;i++){
                c.beginPath();
                c.moveTo(scaleX(character[i].xPos) , scaleY(character[i].yPos));
                c.lineTo(scaleX(character[i].xPos) , scaleY(character[i].PositionY("base")));
                c.stroke();
                c.beginPath();
                c.arc(scaleX(character[i].xPos) , scaleY(character[i].yPos),14,0,6.3);
                if(character[i].user){
                    c.fillStyle = character[i].part.score.fillColor;
                } else {
                    c.fillStyle = "White";
                }

                
                c.fill();
                c.stroke();
                
                if(character[i].user){
                    c.font = "bold 14px Arial";
                    c.textAlign = "center";
                    c.textBaseline = "middle";
                    c.fillStyle = character[i].part.score.textColor;
                    c.fillText(character[i].part.label, scaleX(character[i].xPos) , scaleY(character[i].yPos)); 
                }
                
                
                
            }
            
        }

        function SpawnNewCharacter(p){
            
            var spawnPoint;
            var nextNote;
            if(p.score.aug>0){
                spawnPoint = windowLeft;
                nextNote = 0;
            } else {
                spawnPoint = windowRight;
                nextNote = rhythm.length-1;
            }
            let i = Math.round((spawnPoint*p.score.aug-curBeat+p.score.trans)/-p.score.period);
            if(inInterval(spawnPoint,PositionX(p,curBeat,i),PositionX(p,prevBeat,i))){
                var spawn = Math.random() <= chanceSpawn;
                if(spawn){
                    let user=Math.random() <= chanceUser;
                    let osc=Math.random();
                    if(osc<.5){
                        osc="square";
                    } else {
                        osc="sawtooth";
                    }
                    let filterFreq=500*Math.pow(4,Math.random());
                    let filterQ=10*Math.pow(10,Math.random());
                    let envChoice=Math.floor(Math.random()*8.99);
                    var envGain;
                    var envTime;
                    switch(envChoice) {
                    case 0: envGain=[1,1,0]; envTime=[.01,.2,.3]; break; // regular attack, short sustain, regular release
                    case 1: envGain=[1,1,0]; envTime=[.01,.2,1]; break; // regular attack, short sustain, decay
                    case 2: envGain=[1,1,2,0]; envTime=[.01,.2,.3,.31]; break; // regular attack, short sustain, hard release
                    case 3: envGain=[2,1,1,0]; envTime=[.01,.05,.2,.3]; break; // hard attack, short sustain, regular release
                    case 4: envGain=[2,1,1,0]; envTime=[.01,.05,.2,1]; break; // hard attack, short sustain, decay
                    case 5: envGain=[2,1,1,2,0]; envTime=[.01,.05,.2,.3,.31]; break; // hard attack, short sustain, hard release
                    case 6: envGain=[1,1,0]; envTime=[.1,.2,.3]; break; // soft attack, short sustain, regular release
                    case 7: envGain=[1,1,0]; envTime=[.1,.2,1]; break; // soft attack, short sustain, decay
                    case 8: envGain=[1,1,2,0]; envTime=[.1,.2,.3,.31]; break; // soft attack, short sustain, hard release
                    default: envGain=[1,1,0]; envTime=[.01,.2,.3]; break; 
                    } 
                    var lfoType,lfoOsc,lfoFreq,lfoAmp,lfoShift;
                    
                    if(Math.random()<.5){
                        if(Math.random()<.5){
                            lfoType="vib";
                            lfoFreq=8*Math.pow(1.5,Math.random());
                            if(Math.random()<.5){
                                lfoOsc="sine";
                                lfoAmp=Math.random()*50;
                                lfoShift=0;
                            } else {
                                lfoOsc="square";
                                lfoAmp=Math.random()*200;
                                lfoShift=lfoAmp;
                            }
                        }else{
                            lfoType="trem";
                            lfoFreq=8*Math.pow(3,Math.random());
                            if(Math.random()<.5){
                                lfoOsc="sine";
                                lfoAmp=Math.random()*.5;
                                lfoShift=0;
                            } else {
                                lfoOsc="square";
                                lfoAmp=1;
                                lfoShift=1;
                            }
                        }
                    } else {
                        lfoType="none";
                    }
                    
                    
                    if(user){
                        gain=.8;
                    } else {
                        gain=.2;
                    }
                    let pan=Math.random()*2-1;
                    if(lfoType=="none"){
                        character.push(new Character(p,i,"traveling",nextNote,0,0,user, new Synth(new Timbre(osc,filterFreq,filterQ), null, new Envelope(envGain,envTime), gain, pan)));
                    } else {
                        character.push(new Character(p,i,"traveling",nextNote,0,0,user, new Synth(new Timbre(osc,filterFreq,filterQ), new Lfo(lfoType,lfoOsc,lfoFreq,lfoAmp,lfoShift), new Envelope(envGain,envTime), gain, pan)));
                    }
                        
                }
            }
        }

        function UpdateScreen(){
            prevTime=curTime;
            curTime=new Date().getTime();
            prevBeat = curBeat;
            curBeat = curBeat+bpm/60*.001*(curTime-prevTime);
            canvas.height=window.innerHeight*.95;
            canvas.width=window.innerWidth;
            var e1;
            var e2;
            for(let i=0;i<composite.rhythm.length;i++){
                e1=((prevBeat+.5) % composite.period)-.5;
                e2=((curBeat+.5) % composite.period)-.5;
                if(e1<composite.rhythm[i] && composite.rhythm[i]<=e2){
                    playNote(composite.synth,zeroPitch*Math.pow(2, composite.melody[i]/12));
                    lineHeight=composite.melody[i];
                    lineFade=1;
                    break;
                }
            }
            
            for(let i=0;i<part.length;i++){
               SpawnNewCharacter(part[i]);
            }
            //if(document.hasFocus==false){character=[]}
            for(let i=0;i<character.length;i++){
               character[i].update();
               if (character[i].status=="dead"){
                   character.splice(i, 1);
                   i=i-1;
               }
            }
            drawEverything();
            if(!document.hidden && !stopNow){
                requestAnimationFrame(UpdateScreen);
            } else {
                character=[];
                c.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById("title").style.display="block";
                document.getElementById("controls").style.display="none";
            }
            
        }
        
        function Score(aug,trans,period,melody,mDip,base,bDip,fillColor,textColor){
            this.aug = aug;
            this.trans = trans;
            this.period = period;
            this.melody = melody;
            this.mDip = mDip;
            this.base = base;
            this.bDip = bDip;
            this.fillColor = fillColor;
            this.textColor = textColor;
        }

        function Timbre(osc,filterFreq,filterQ){
            this.osc = osc;
            this.filterFreq = filterFreq;
            this.filterQ = filterQ;
        }
        function Lfo(type,osc,freq,amp,shift){
            this.type = type;
            this.osc = osc;
            this.freq = freq;
            this.amp = amp;
            this.shift = shift;
        }
        function Envelope(gain,time){
            this.gain = gain;
            this.time = time;
        }
        function Synth(timbre,lfo,envelope,gain,pan){
            this.timbre = timbre;
            this.lfo = lfo;
            this.envelope = envelope;
            this.gain = gain;
            this.pan = pan;
        }
        function Part(score,key,label) {
            this.score = score;
            this.key = key;
            this.label = label;
        }
        
        
        

        
        
        

    </script>
</body>
</html>