
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Can you canon?</title>
</head>
<style>
    html, body {margin: 0; height: 100%; overflow: hidden}
    td {border: 1px solid black;}
    .center {
        margin-left: auto;
        margin-right: auto;
        }
</style>
<body>
    <table>
        <tr >
            
            <td style="width:30%;border-style: none;vertical-align: top;">
                Instructions
                <div style="border-style:double;height:5em;overflow-y:scroll;overflow-x:auto">
                    Compose a canon following this rule: if two parts play on the same beat, they must do so in unison. Try to cram in as many parts as possible into the space provided!
                    <ul style="margin:0">
                        <li>Use the arrow keys to move the parts around.</li>
                        <li>Use the spacebar or enter key to add a new part.</li>
                        <li>Use the delete or backspace button to remove a part.</li>
                        <li>To activate a different part (to move or delete it), press the corresponding number on the keyboard/number pad.</li>
                    </ul> 
                </div >
                
                <br>
                <button id="playButton" onclick="playButton()">Hear your canon</button>
                <br>
                Choose parts to emphasize: 
                <input type="text" id="leftPart" maxLength="2" size="2" inputmode="numeric" >
                <input type="text" id="rightPart" maxLength="2" size="2" inputmode="numeric">
                <br>
                <br>
                <label for="tempo">Tempo: </label>
                <input type="text" id="tempo" maxLength="3" size="3" value="150" inputmode="numeric"><br>
                <label for="baseFreq">Base frequency: </label>
                <input type="text" id="baseFreq" maxLength="3" size="3" value="220" inputmode="numeric"><br>
                <label for="nTET">Tones per octave: </label>
                <input type="text" id="nTET" maxLength="3" size="3" value="12" inputmode="numeric"><br>
                <br>
                <div id="solutions" style="border-style:double;height:4em;overflow-y:scroll;overflow-x:auto">
                    
                </div >
                <br>
                Done composing? <button id="doneButton" onclick="doneButton()">Try playing your canon!</button> <br>
            </td>
            <td style="width:70%;border-style: none;vertical-align: top;">
                <canvas id="myCanvas"> </canvas>
            </td>
        </tr>
    </table>


    <script src="curve.js"></script>
    <script src="audio.js"></script>
    <script src="solver.js"></script>
    
    <script>
        function solve(){
            solutions = [[]];
            findMax(rhythm,melody,solutions);
            if(solutions[solutions.length-1]==="quit"){
                document.getElementById("solutions").innerHTML = "Sorry. Optimal solutions could not be found. The algorithm was taking too long.";
            } else {
                document.getElementById("solutions").innerHTML ="Want to see the optimal solutions? Scroll down! <br><br><br><br>";            
                document.getElementById("solutions").innerHTML += "Construct a canon with parts starting on beats...";
                document.getElementById("solutions").innerHTML += "<br />";
                for(let i=0;i<solutions[solutions.length-1].length;i++){
                    document.getElementById("solutions").innerHTML += solutions[solutions.length-1][i];
                    document.getElementById("solutions").innerHTML += "<br />";
                }
            }
            
        }

        function doneButton(){
            let s = "";
            const period=maxX+4;
            for(let i=0;i<partList.length;i++){
                partList[i].rhythm="";
                partList[i].melody="";
                for(let j=0;j<rhythm.length;j++){
                    const t=rhythm[j]+partList[i].horizontalShift;
                    const p=melody[j]+partList[i].verticalShift;
                    partList[i].rhythm += t + ",";
                    console.log(i,j,partList[i].rhythm);
                    partList[i].melody += p + ",";
                }
                partList[i].rhythm = partList[i].rhythm.slice(0, -1);
                partList[i].melody = partList[i].melody.slice(0, -1);
                
                s=s+partList[i].rhythm+";"+period+";"+partList[i].melody+".";
            }
            s = s.slice(0, -1);


            window.location="PlayCanon.html?CanonData="+s;
        }



        let audioCtx;

        let currentTime;
        let prevTime;
        let currentBeat;
        let prevBeat;
        let currentlyPlaying=false;
        var canvas = document.getElementById("myCanvas");
        var c = canvas.getContext("2d");
        


        const q = new URLSearchParams(window.location.search);
        let rhythm;
        let melody;
        let maxX;

        if(q==""){
            rhythm=[0,2,7,8,11];
            melody=[0,7,8,2,11];
            maxX=22;
        } else {
            rhythm = q.get("rhythm").split(",").map(Number);
            melody = q.get("pitches").split(",").map(Number);
            maxX = Math.max(...rhythm)*2;
        }
        
        let maxY;
        let minY;

        function adjustWindow(){
            maxY = -999;
            minY = 999;
            for(let i=0;i<partList.length;i++){
                maxY=Math.max(maxY,Math.max(...melody)+partList[i].verticalShift);
                minY=Math.min(minY,Math.min(...melody)+partList[i].verticalShift);
            }
            maxY = maxY+2;
            minY = minY-2;
        }
        


        let currentPart = 1;
        function playButton(){
            document.getElementById('playButton').blur(); 
            if(currentlyPlaying==false){
                currentBeat = -3; 
                currentlyPlaying = true; 
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } else {
                currentlyPlaying=false;
            }
        }
        function part(horizontalShift, verticalShift){
            this.horizontalShift=horizontalShift;
            this.verticalShift=verticalShift;
            this.hue=randHue();
        }
        
        let partList = [
            new part(0,0,randHue()),
            new part(rhythm[rhythm.length-1],0,randHue()),

        ];

        function randHue(){
            return Math.random()*180+120;
        }

        function adjustHue(){
            for(let i=0;i<partList.length;i++){
                partList[i].hue+=Math.random()-.5;
                for(let j=0;j<partList.length;j++){
                    if(j!=i){
                        let diff=partList[i].hue-partList[j].hue;
                        if(Math.abs(diff)<90){
                            partList[i].hue+=10*Math.sign(diff)*(90-Math.abs(diff))/90/Math.abs(i-j);
                        }
                        
                    }
                }
                if(partList[i].hue<120){partList[i].hue=120+Math.random()}
                if(partList[i].hue>360){partList[i].hue=360-Math.random()}
            }
        }
        function distBeatPart(b,p){
            let d = 999;
            for(let i=0;i<rhythm.length;i++){
                if(Math.abs(partList[p].horizontalShift+rhythm[i]-b)<d){
                    d=Math.abs(partList[p].horizontalShift+rhythm[i]-b);
                }
            }
            return d;
        }
        function drawEverything(){
            canvas.height=window.innerHeight-5;
            canvas.width=window.innerWidth*.69;
            prevTime=currentTime;
            currentTime = Date.now();
            
            
            adjustHue();
            
            let prime = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97];
            c.clearRect(0,0,canvas.width,canvas.height);
            c.globalAlpha=1;
            c.lineCap = "round";
            c.lineWidth = 1;
            for(let i=0;i<maxX+1;i++){
                c.beginPath();
                if((i+500) % 5 ==0){c.strokeStyle = "gray";} else {c.strokeStyle = "lightGray";}
                let x=canvas.width/(maxX+2)*(i+1); 
                c.moveTo(x,canvas.height-20-(canvas.height-20)/(maxY-minY+2));
                c.lineTo(x,canvas.height-20-(canvas.height-20)/(maxY-minY+2)*(maxY-minY+1));
                c.stroke();
            }
            for(let i=minY;i<maxY+1;i++){
                c.beginPath();
                if((i+500) % 5 ==0){c.strokeStyle = "gray";} else {c.strokeStyle = "lightGray";}
                let y=canvas.height-20-(canvas.height-20)/(maxY-minY+2)*(i-minY+1);
                c.moveTo(canvas.width/(maxX+2),y);
                c.lineTo(canvas.width/(maxX+2)*(maxX+1),y);
                c.stroke();
            }
            
            const maxRadius = Math.min(canvas.width/(maxX+2),(canvas.height-20)/(maxY-minY+2),20)/2;

            c.font = "20px Arial";
            c.textBaseline = 'middle';
            c.textAlign = 'right';
            c.fillStyle = "gray";
            c.globalAlpha=1;
            for(let i=Math.ceil(minY/5)*5;i<=maxY;i+=5){
                c.fillText(i, canvas.width/(maxX+2)*(0+1)-maxRadius-5, canvas.height-20-(canvas.height-20)/(maxY-minY+2)*(i+1-minY));
            }
            c.textBaseline = 'top';
            c.textAlign = 'center';
            for(let i=0;i<=maxX;i+=5){
                c.fillText(i, canvas.width/(maxX+2)*(i+1), canvas.height-20-(canvas.height-20)/(maxY-minY+2)*(0+1)+maxRadius+5);
            }




            let errMin = [];
            let errMax = [];
            for(let i=0;i<partList.length;i++){
                let r;
                if(currentlyPlaying==true){
                    if(i==myParseInt(document.getElementById("leftPart").value,0)-1 || i==myParseInt(document.getElementById("rightPart").value,0)-1){
                        r = maxRadius*(.8+.4*Math.max(0,1-2*distBeatPart(currentBeat,i)));
                    }else{
                        r = maxRadius*(.4+.1*Math.cos(prime[i+1]/prime[i]*currentTime/500));
                    }
                } else {
                    if(i!=currentPart){
                        r = maxRadius*(.4+.1*Math.cos(prime[i+1]/prime[i]*currentTime/500));
                    }else{
                        r = maxRadius*(.8+.2*Math.cos(prime[i+1]/prime[i]*currentTime/500));
                    }
                }
                
                c.lineWidth=2;
                c.strokeStyle="hsl("+partList[i].hue+",100%,50%)";  
                c.fillStyle="hsl("+partList[i].hue+",100%,50%)";  
                let pts=[];
                for(let j=0; j<rhythm.length;j++){
                    c.beginPath();
                    let x = canvas.width/(maxX+2)*(1+partList[i].horizontalShift+rhythm[j]); 
                    let y = canvas.height-20-(canvas.height-20)/(maxY-minY+2)*(1+partList[i].verticalShift+melody[j]-minY);
                    pts.push(x,y);
                    c.beginPath();
                    c.arc(x,y,r,0,6.28);
                    c.globalAlpha=1;
                    
                    c.stroke();

                    c.font = "30px Arial";
                    if(j==0){

                        c.textAlign = 'left';
                        c.textBaseline = 'middle';
                        c.fillStyle = "black";
                        c.fillText(i+1, x+maxRadius, y);
                        c.fillStyle="hsl("+partList[i].hue+",100%,50%)";
                    }
                    
                    
                    if(errMax[partList[i].horizontalShift+rhythm[j]]==null){
                        errMax[partList[i].horizontalShift+rhythm[j]]=partList[i].verticalShift+melody[j];
                        errMin[partList[i].horizontalShift+rhythm[j]]=partList[i].verticalShift+melody[j];
                    } else {
                        if(partList[i].verticalShift+melody[j]>errMax[partList[i].horizontalShift+rhythm[j]]){
                            errMax[partList[i].horizontalShift+rhythm[j]]=partList[i].verticalShift+melody[j];
                        }
                        if(partList[i].verticalShift+melody[j]<errMin[partList[i].horizontalShift+rhythm[j]]){
                            errMin[partList[i].horizontalShift+rhythm[j]]=partList[i].verticalShift+melody[j];
                        }
                        
                    }
                }
                c.globalAlpha=1*(r/maxRadius);
                c.lineWidth=1;
                c.beginPath();
                c.curve(pts);
                c.stroke();
                c.globalAlpha=.6*(r/maxRadius);
                c.lineWidth=1.5*r;
                c.beginPath();
                c.curve(pts);
                c.stroke();
            }
            c.fillStyle="black";
            c.globalAlpha=.4;
            for(let i=0;i<errMin.length;i++){
                if(errMin[i]!=null){
                    if(errMin[i]<errMax[i]){
                        c.beginPath();
                        let x= (1+i)*canvas.width/(maxX+2);
                        let y1=canvas.height-20-(1+errMin[i]-minY)*(canvas.height-20)/(maxY-minY+2)+maxRadius;
                        let y2=canvas.height-20-(1+errMax[i]-minY)*(canvas.height-20)/(maxY-minY+2)-maxRadius;
                        c.rect(x-maxRadius,y1,maxRadius*2,y2-y1);
                        c.fill();
                    }
                    
                }
            }
            if(currentlyPlaying==true){
                prevBeat=currentBeat;
                currentBeat+=(currentTime-prevTime)/60000*myParseInt(document.getElementById("tempo").value,150,60,300);
                if(currentBeat>maxX+1){
                    currentlyPlaying=false;
                } else {
                    c.beginPath();
                    c.moveTo(canvas.width/(maxX+2)*(currentBeat+1),0);
                    c.lineTo(canvas.width/(maxX+2)*(currentBeat+1),canvas.height);
                    c.lineWidth=2;
                    c.strokeStyle="black";
                    c.stroke();
                }
                let alreadyPlaying = [];
                for(let i=0;i<partList.length;i++){
                    for(let j=0;j<rhythm.length;j++){
                        const y = partList[i].horizontalShift+rhythm[j];
                        if(prevBeat<y && y<=currentBeat){
                            const f=myParseInt(document.getElementById("baseFreq").value,220,55,880)*2**((partList[i].verticalShift+melody[j])/myParseInt(document.getElementById("nTET").value,12,6));
                            if(myParseInt(document.getElementById("leftPart").value,0)-1==i){
                                playNote(f,0);
                            } else if(myParseInt(document.getElementById("rightPart").value,0)-1==i){
                                playNote(f,1);
                            } 
                            if(alreadyPlaying.includes(f)===false){
                                playNote(f,2);
                                alreadyPlaying.push(f);
                            }
                            
                        }
                    }
                }

            }
        }
        function animationLoop(){
            if(!document.hasFocus()){currentlyPlaying=false}
            drawEverything();
            window.requestAnimationFrame(animationLoop);
        }
        document.addEventListener('keydown', function(event) {
            event.preventDefault;
            if(document.activeElement.tagName==="INPUT"){
                if(event.key==="Enter"){
                    document.activeElement.blur();
                }
                return;
            }
            if(currentlyPlaying==false){
                switch(event.key){
                    case "ArrowUp":
                        event.preventDefault;
                        partList[currentPart].verticalShift+=1;
                        break;
                    case "ArrowDown":
                        event.preventDefault;
                        partList[currentPart].verticalShift-=1;
                        break;
                    case "ArrowRight":
                        event.preventDefault;
                        if(partList[currentPart].horizontalShift<maxX-Math.max(...rhythm)){partList[currentPart].horizontalShift+=1};
                        break;
                    case "ArrowLeft":
                        event.preventDefault;
                        if(partList[currentPart].horizontalShift>0) {partList[currentPart].horizontalShift-=1};
                        break;
                    case "Backspace":
                    case "Delete":
                        if(partList.length>1){partList.splice(currentPart,1)};
                        currentPart=partList.length-1;
                        break;
                    case "Enter":
                    case " ":
                        event.preventDefault;
                        const n = partList.length-1;
                        if(partList.length<15){
                            partList.push(new part(Math.max(...rhythm),0))
                        }
                        currentPart=partList.length-1;
                        break;
                    default:
                        let p=myParseInt(event.key,-1)-1;
                        if(p>=0 && p<partList.length){
                            currentPart = p;
                        }
                }
                adjustWindow();
            }
            
        });
        adjustWindow();
        animationLoop();
        function myParseInt(s,defaultVal,minVal=-99999,maxVal=99999){
            if(isNaN(s)){
                return defaultVal;
            } else {
                const n=parseInt(s);
                if(n<=maxVal &&  n>=minVal){
                    return n
                } else {
                    return defaultVal;
                }
            }
        }
        solve();
    </script>
    
</body>

