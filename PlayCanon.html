<!-- 
make more levels
fix feedback/help
clean everything up
fix parameter ranges and default values (try on multiple devices)

 -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Can you canon?</title>
    
</head>
<style>
    html, body {    
        overflow-x: hidden;
        overflow-y: hidden;
    }
    canvas{
        position:absolute;
        left:0;
        top:0;
        z-index:-1;
    }
</style>
<body>
    <canvas id="myCanvas" > </canvas>
    <div style="width:25%">
        <button id="startStopButton" onclick="startStopToggle()">Start Playing</button>
        <br>
        <br>
        Keep the red balls from touching the center line by activating the left and right bumpers with the "F" and "J" keys.
        <br>
        <br>
        Left part: 
        <input type="text" id="leftPart" maxLength="2" size="2" inputmode="numeric" onchange="currentParts[0]=document.getElementById('leftPart').value-1; characterList=[];">
        <br>
        Right part: 
        <input type="text" id="rightPart" maxLength="2" size="2" inputmode="numeric" onchange="currentParts[1]=document.getElementById('rightPart').value-1; characterList=[];">

        <br>
        <br>
        <label for="tempo">Tempo: </label>
        <input type="text" id="tempo" maxLength="3" size="3" value="150" inputmode="numeric"><br><br>
        <label for="baseFreq">Base frequency: </label>
        <input type="text" id="baseFreq" maxLength="3" size="3" value="220" inputmode="numeric"><br>
        <label for="nTET">Tones per octave: </label>
        <input type="text" id="nTET" maxLength="3" size="3" value="12" inputmode="numeric"><br>
    </div>
    

                


    <script src="audio.js" type="text/javascript"></script>
    <script>
        function loadCanon(x){
            const q = new URLSearchParams(window.location.search);
            if(q==""){
                partList = [
                    new part([0,2,7,8,11],25,[0,7,8,2,11]),
                    new part([2,4,9,10,13],25,[7,14,15,9,18]),
                    new part([7,9,14,15,18],25,[8,15,16,10,19]),
                    new part([8,10,15,16,19],25,[2,9,10,4,13]),
                    new part([11,13,18,19,22],25,[11,18,19,13,22]),
                ];
            } else {
                let step1 = q.get("CanonData").split(".");
                let step2 = [];
                for(let i=0;i<step1.length;i++){
                    step2.push(step1[i].split(";"));
                }
                
                partList = [];
                for(let i=0;i<step2.length;i++){
                    partList.push(new part(step2[i][0].split(",").map(Number),parseFloat(step2[i][1]),step2[i][2].split(",").map(Number)));
                }
            }
        }

        function part(rhythm,period,melody){
            this.rhythm = rhythm;
            this.period = period;
            this.melody = melody;
        }
        let partList = [];
        let composite = [];
        let yMin;
        let yMax;

        let bounciness;
        function setUpLevel(){
            bounciness=0;
            yMin = 999;
            yMax = -999
            
            for(let i=0;i<partList.length;i++){

                if(Math.max(...partList[i].melody)>yMax){yMax=Math.max(...partList[i].melody)};
                if(Math.min(...partList[i].melody)<yMin){yMin=Math.min(...partList[i].melody)};
            }

            let yRange = yMax-yMin;
            yMin = yMin - .15*yRange;
            yMax = yMax + .15*yRange;
            for(let i=0;i<partList.length;i++){
                partList[i].rhythm.unshift(partList[i].rhythm[0]-6);
                partList[i].rhythm.push(partList[i].rhythm[partList[i].rhythm.length-1]+4);
                if(partList[i].melody[0]<=partList[i].melody[partList[i].melody.length-1]){
                    partList[i].melody.unshift(yMin-(partList[i].melody[0]-yMin));
                    partList[i].melody.push(yMax+(yMax-partList[i].melody[partList[i].melody.length-1]));
                } else {
                    partList[i].melody.unshift(yMax+(yMax-partList[i].melody[0]));
                    partList[i].melody.push(yMin-(partList[i].melody[partList[i].melody.length-1]-yMin));
                }
                
                for(let j=0;j<partList[i].rhythm.length-1;j++){
                    if(partList[i].rhythm[j+1]-partList[i].rhythm[j]>bounciness){
                        bounciness=partList[i].rhythm[j+1]-partList[i].rhythm[j];
                    }
                }
            }
            console.log(bounciness);
            
            document.getElementById("leftPart").value=1;
            document.getElementById("rightPart").value=partList.length;
            currentParts[0]=0
            currentParts[1]=partList.length-1
        }


        // var myTouchEvent = function (e) {
        //     e.preventDefault();
        //     for(let i = 0;i<e.touches.length;i++){
        //         let touch = e.touches[i];
        //         let s;
        //         if(touch.pageX<canvas.width/2){
        //             s=0;
        //         } else {
        //             s=1;
        //         }
        //         if(curBeat-paddle[s].zeroBeat>.4){
        //             let a = (canvas.height+canvas.offsetTop-touch.pageY)/canvas.height;
        //             paddle[s].height = (1-a)*yMin+a*yMax;
        //             paddle[s].zeroBeat = curBeat; 
        //             paddle[s].hit = false;
        //         }
        //     }
        // }


        var myKeyboardEvent = function (e) {
            if(document.activeElement.tagName==="INPUT"){
                if(event.key==="Enter"){
                    document.activeElement.blur();
                }
                return;
            }
            let s;
            if(leftKeys.includes(e.key)){
                e.preventDefault();
                s=0;
            } else if(rightKeys.includes(e.key)){
                e.preventDefault();
                s=1;
            } else {
                return;
            }

            if(curBeat-paddle[s].zeroBeat>.4){
                paddle[s].zeroBeat = curBeat; 
                paddle[s].hit = false;
            }
        }










        function drawField(){
            c.strokeStyle = "Black";
            c.fillStyle = "Black";
            c.beginPath();
            c.rect(canvas.width/2-2*ballRadius,0,4*ballRadius,canvas.height);
            c.fill();
            c.stroke();
        }

        function drawStuff(){
            
            canvas.width/2-3*ballRadius;
            c.lineWidth = 2;
            let alreadyPlaying=[];
            for(let i=0;i<partList.length;i++){
                for(let j=1;j<partList[i].rhythm.length-1;j++){
                    let t1 = prevBeat % partList[i].period;
                    let t2 = curBeat % partList[i].period;
                    if(t1>t2){t1=t1-partList[i].period}
                    if(t1<partList[i].rhythm[j] && partList[i].rhythm[j] <= t2){
                        const f=myParseInt(document.getElementById("baseFreq").value,220,55,880)*2**(partList[i].melody[j]/myParseInt(document.getElementById("nTET").value,12,6));
                        if(alreadyPlaying.includes(f)===false){
                            playNote(f,2);
                            alreadyPlaying.push(f);
                        }
                    }
                }
            }
            
            
            let yScale = canvas.height/(yMax-yMin);


            let grad1= c.createLinearGradient(canvas.width/2-2*ballRadius, 0, (canvas.width/2-2*ballRadius)*(1-paddle[0].score), 0);
            grad1.addColorStop(0, "lightGreen");
            grad1.addColorStop(1, "white");
            c.fillStyle = grad1;

            c.beginPath();
            c.rect(canvas.width/2-2*ballRadius,0,-paddle[0].score*(canvas.width/2-2*ballRadius),canvas.height);
            c.fill();

            let grad2= c.createLinearGradient(canvas.width/2+2*ballRadius, 0, (canvas.width/2+2*ballRadius)+(canvas.width/2-2*ballRadius)*paddle[1].score, 0);
            grad2.addColorStop(0, "lightGreen");
            grad2.addColorStop(1, "white");
            c.fillStyle = grad2;

            c.beginPath();
            c.rect(canvas.width/2+2*ballRadius,0,paddle[1].score*(canvas.width/2-2*ballRadius),canvas.height);
            c.fill();

            for(let i=characterList.length-1;i>=0;i--){
                let b=curBeat-characterList[i].zeroBeat*characterList[i].part.period;
                let j = whichNote(characterList[i].part,b);
                if(j==characterList[i].part.rhythm.length-1){
                    characterList.splice(i,1);
                    continue;
                }
                if(j>0 && j<characterList[i].part.rhythm.length) {
                    if(whichNote(characterList[i].part,prevBeat-characterList[i].zeroBeat*characterList[i].part.period)<j){
                        if(characterList[i].side=="L"){
                            if(curBeat-paddle[0].zeroBeat>.4){
                                characterList[i].missedNote=j;
                                characterList[i].beatMissedNote=curBeat;

                            } else {
                                playNote(myParseInt(document.getElementById("baseFreq").value,220,55,880)*2**(characterList[i].part.melody[j]/myParseInt(document.getElementById("nTET").value,12,6)),0);
                                paddle[0].score = paddle[0].score+1/(3*(characterList[i].part.rhythm.length-2));
                                paddle[0].hit = true;
                                
                            }
                        } else if(characterList[i].side=="R"){
                            if(curBeat-paddle[1].zeroBeat>.4){
                                characterList[i].missedNote=j;
                                characterList[i].beatMissedNote=curBeat;

                            } else {
                                playNote(myParseInt(document.getElementById("baseFreq").value,220,55,880)*2**(characterList[i].part.melody[j]/myParseInt(document.getElementById("nTET").value,12,6)),1);
                                paddle[1].score = paddle[1].score+1/(3*(characterList[i].part.rhythm.length-2));
                                paddle[1].hit = true;
                            }
                        }
                    }
                }
                
                if(characterList[i].missedNote!=null){
                    if(curBeat-characterList[i].beatMissedNote>.4){
                        if(characterList[i].side=="L"){
                            paddle[0].score = 0;
                        } else if(characterList[i].side=="R"){
                            paddle[1].score = 0;
                        }
                        characterList.splice(i,1);
                        continue;
                    }
                    if(characterList[i].side=="L" && curBeat-paddle[0].zeroBeat<.4){
                        characterList[i].missedNote=null;
                        characterList[i].beatMissedNote=null;
                        playNote(myParseInt(document.getElementById("baseFreq").value,220,55,880)*2**(characterList[i].part.melody[j]/myParseInt(document.getElementById("nTET").value,12,6)),0);
                        paddle[0].score = paddle[0].score+1/(3*(characterList[i].part.rhythm.length-2));
                        paddle[0].hit = true;
                    }

                    if(characterList[i].side=="R" && curBeat-paddle[1].zeroBeat<.4){
                        characterList[i].missedNote=null;
                        characterList[i].beatMissedNote=null;
                        playNote(myParseInt(document.getElementById("baseFreq").value,220,55,880)*2**(characterList[i].part.melody[j]/myParseInt(document.getElementById("nTET").value,12,6)),1);
                        paddle[1].score = paddle[1].score+1/(3*(characterList[i].part.rhythm.length-2));
                        paddle[1].hit = true;
                    }

                    j=characterList[i].missedNote-1;
                }
                let hDisplace = canvas.width/2*(characterList[i].part.rhythm[j+2]-characterList[i].part.rhythm[j+1])/bounciness;
                if(j>-1){
                    let y1;
                    let y2;
                    let y;
                    let k=(b-characterList[i].part.rhythm[j])/(characterList[i].part.rhythm[j+1]-characterList[i].part.rhythm[j]);
                    if(j<characterList[i].part.rhythm.length-2){
                        c.beginPath();
                        y1=yScale*(yMax-characterList[i].part.melody[j+1]);
                        y2=yScale*(yMax-characterList[i].part.melody[j+2]);
                        c.strokeStyle = "Gray";
                        c.globalAlpha = Math.max(.5*(k-.3)/.7,0);
                        
                        
                        if(characterList[i].side=="L"){
                            c.moveTo(canvas.width/2-3*ballRadius,y1);
                            c.quadraticCurveTo(canvas.width/2-3*ballRadius-hDisplace,(y1+y2)/2,canvas.width/2-3*ballRadius,y2);
                            c.stroke();
                        } else {
                            c.moveTo(canvas.width/2+3*ballRadius,y1);
                            c.quadraticCurveTo(canvas.width/2+3*ballRadius+hDisplace,(y1+y2)/2,canvas.width/2+3*ballRadius,y2);
                            c.stroke();
                        }
                    }
                
                    y=yScale*(yMax-(k*characterList[i].part.melody[j+1]+(1-k)*characterList[i].part.melody[j]));
                    y1=yScale*(yMax-characterList[i].part.melody[j]);
                    y2=yScale*(yMax-characterList[i].part.melody[j+1]);
                    hDisplace = canvas.width/2*(characterList[i].part.rhythm[j+1]-characterList[i].part.rhythm[j])/bounciness;
                    c.beginPath();
                    c.strokeStyle="Gray";
                    if(j==0){
                        c.globalAlpha=.5*k;
                    } else if(j==characterList[i].part.rhythm.length-2){
                        c.globalAlpha=.5*(1-k);
                    } else {
                        c.globalAlpha=.5;
                    }
                    if(characterList[i].side=="L"){
                        c.moveTo(canvas.width/2-3*ballRadius,y1);
                        c.quadraticCurveTo(canvas.width/2-3*ballRadius-hDisplace,(y1+y2)/2,canvas.width/2-3*ballRadius,y2);
                        c.stroke();
                    } else {
                        c.moveTo(canvas.width/2+3*ballRadius,y1);
                        c.quadraticCurveTo(canvas.width/2+3*ballRadius+hDisplace,(y1+y2)/2,canvas.width/2+3*ballRadius,y2);
                        c.stroke();
                    }
                    c.globalAlpha=1;

                    let z = yScale*(yMax-(((1-k)*(2*k)+k*(2-2*k))*characterList[i].part.melody[j+1]+(1-((1-k)*(2*k)+k*(2-2*k)))*characterList[i].part.melody[j])); 
                    let zz= hDisplace*((1-k)*k+k*(1-k));
                    if(zz>-2*ballRadius){
                        c.beginPath();
                        if(characterList[i].side=="L"){
                            c.arc(canvas.width/2-3*ballRadius-zz, y,ballRadius,0,6.28);
                        } else {
                            c.arc(canvas.width/2+3*ballRadius+zz, y,ballRadius,0,6.28);
                        }
                        c.fillStyle = "Red";
                        c.fill();
                    }
                    
                }
                
            }
            for(let i=0;i<2;i++){
                if(curBeat-paddle[i].zeroBeat<.4){
                    c.beginPath();
                    if(i==0){
                        c.rect(canvas.width/2-2*ballRadius,.05*canvas.height,-ballRadius,.9*canvas.height);
                    } else {
                        c.rect(canvas.width/2+2*ballRadius,.05*canvas.height,ballRadius,.9*canvas.height);
                    }
                    c.fillStyle = "Blue";
                    c.fill();
                }
            }
            
            for(s=0;s<=1;s++){
                if(paddle[s].hit==false && curBeat-paddle[s].zeroBeat>.4){
                    paddle[s].score=0;
                }
            }
            drawField();
        }

        function beginPlaying(){
            audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
            prevTime = audioCtx.currentTime; 

            prevTime=new Date().getTime();
            curTime=new Date().getTime();
            prevBeat = -.5;
            curBeat = -.5;
            paddle = [{"height": -999, "zeroBeat": -999, "score": 0, "hit": false},{"height": -999, "zeroBeat": -999, "score": 0, "hit": false}];
            
            currentStage = 0;
            characterList = [];
            gameLoop();
        }

        function gameLoop(){

            prevTime=curTime;
            curTime=new Date().getTime();
            prevBeat = curBeat;
            curBeat = curBeat+myParseInt(document.getElementById("tempo").value,150,60,300)/60*.001*(curTime-prevTime);
            canvas.height=window.innerHeight;
            canvas.width=window.innerWidth;
            spawnNewCharacter();
            drawStuff();
            if(!document.hasFocus || document.hidden){
                startStopToggle();
            }
            if(playState==true){
                requestAnimationFrame(gameLoop);
            } else {
                c.clearRect(0,0,canvas.width,canvas.height);
                drawField();
            }
        }
        function myMod(a,b){
            return ((a % b) + b) % b
        }

        function spawnNewCharacter(){
            let s;
            for(let i=0;i<2;i++){
                if(myMod(curBeat-partList[currentParts[i]].rhythm[0],partList[currentParts[i]].period)<myMod(prevBeat-partList[currentParts[i]].rhythm[0],partList[currentParts[i]].period)){
                    if(i==0){
                        s="L";
                    } else {
                        s="R";
                    }
                    
                    characterList.push(new character(partList[currentParts[i]],Math.round((curBeat-partList[currentParts[i]].rhythm[0])/partList[i].period,0),s));
                }
            }
        }

        function whichNote(p,b){
            let j;
            for(j=p.rhythm.length-1;j>=0;j--){
                if(p.rhythm[j]<b){break}
            }
            return j;
        }

        function startStopToggle(){
            if(playState==false){
                playState=true;
                document.getElementById("startStopButton").innerHTML = "Stop Playing";
                beginPlaying();
            } else {
                playState=false;
                document.getElementById("startStopButton").innerHTML = "Start Playing";
            }
        }




        let characterList = [];
        let paddle = [];
        let playState = false;
        let prevTime;
        let curTime;
        let prevBeat;
        let curBeat;
        let audioCtx;
        let boundaryWidth=80;
        let ballRadius=10;
        let paddleWidth=10;
        let currentParts = [0,0];
        let canvas = document.getElementById("myCanvas");
        let c = canvas.getContext("2d");
        canvas.addEventListener('touchstart', function(e) {myTouchEvent(e);}, 0);
        document.addEventListener('keydown', function(e) {myKeyboardEvent(e);});
        const leftKeys = ["f","F","d","D","s","S","a","A"];
        const rightKeys = ["j","J","k","K","l","L",";",":"];
        let filterFreq = 1000;
        let filterQ = 10;
        function character(part,zeroBeat,side){
            this.part = part;
            this.zeroBeat=zeroBeat;
            this.side = side;
            this.missedNote = null;
            this.beatMissedNote = null;
        }

        

        function myParseInt(s,defaultVal,minVal=-99999,maxVal=99999){
            if(isNaN(s)){
                return defaultVal;
            } else {
                const n=parseInt(s);
                if(n<=maxVal &&  n>=minVal){
                    return n
                } else {
                    return defaultVal;
                }
            }
        }



        

        loadCanon();
        setUpLevel();
    </script>
    
    
    
    
    
</body>
